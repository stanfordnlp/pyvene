
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Nested Hierarchical Structure with MQNLI &#8212; pyvene 0.1.2 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=0deb7d70"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'tutorials/advanced_tutorials/MQNLI';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="An Exploration on Voting Mechanisms" href="Voting_Mechanism.html" />
    <link rel="prev" title="Intervening on Vision-Language Models" href="Interventions_with_BLIP.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">pyvene 0.1.2 documentation</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Guides</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../guides/contributing.html">Contributing Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/causal_abstraction.html">A Little Guide to Causal Abstraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/ndif.html">NDIF Integration</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Basic tutorials</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../pyvene_101.html">Introduction to pyvene</a></li>

<li class="toctree-l1"><a class="reference internal" href="../basic_tutorials/Add_Activations_to_Streams.html">Activation Addition</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basic_tutorials/Basic_Intervention.html">Interchange Intervention</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basic_tutorials/Nested_Intervention.html">Intervening on subcomponents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basic_tutorials/Subspace_Partition_with_Intervention.html">Subspace Interventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basic_tutorials/Intervention_Training.html">Trainable Interventions</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Advanced tutorials</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Causal_Tracing.html">Causal Tracing (ROME)</a></li>

<li class="toctree-l1"><a class="reference internal" href="Probing_Gender.html">Causal Evaluation of Probes</a></li>
<li class="toctree-l1"><a class="reference internal" href="DAS_Main_Introduction.html">Intro to Distributed Alignment Search (DAS)</a></li>




<li class="toctree-l1"><a class="reference internal" href="Boundless_DAS.html">Boundless DAS</a></li>
<li class="toctree-l1"><a class="reference internal" href="IOI_Replication.html">Replicating the IOI paper</a></li>
<li class="toctree-l1"><a class="reference internal" href="IOI_with_DAS.html">IOI with DAS</a></li>
<li class="toctree-l1"><a class="reference internal" href="IOI_with_Mask_Intervention.html">IOI with Masked Interventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="Interventions_with_BLIP.html">Intervening on Vision-Language Models</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Nested Hierarchical Structure with MQNLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="Voting_Mechanism.html">An Exploration on Voting Mechanisms</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">API</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../api/core.html"><code class="docutils literal notranslate"><span class="pre">pyvene</span></code>: Core API</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/pyvene.data_generators.html">pyvene.data_generators</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.data_generators.causal_model.html">pyvene.data_generators.causal_model</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.data_generators.causal_model.simple_example.html">pyvene.data_generators.causal_model.simple_example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.data_generators.causal_model.CausalModel.html">pyvene.data_generators.causal_model.CausalModel</a></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/pyvene.models.html">pyvene.models</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.backpack_gpt2.html">pyvene.models.backpack_gpt2</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.backpack_gpt2.modelings_backpack_gpt2.html">pyvene.models.backpack_gpt2.modelings_backpack_gpt2</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.backpack_gpt2.modelings_intervenable_backpack_gpt2.html">pyvene.models.backpack_gpt2.modelings_intervenable_backpack_gpt2</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.basic_utils.html">pyvene.models.basic_utils</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.basic_utils.GET_LOC.html">pyvene.models.basic_utils.GET_LOC</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.basic_utils.closeness_to_permutation_loss.html">pyvene.models.basic_utils.closeness_to_permutation_loss</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.basic_utils.count_parameters.html">pyvene.models.basic_utils.count_parameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.basic_utils.create_directory.html">pyvene.models.basic_utils.create_directory</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.basic_utils.embed_to_distrib.html">pyvene.models.basic_utils.embed_to_distrib</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.basic_utils.format_token.html">pyvene.models.basic_utils.format_token</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.basic_utils.get_batch_size.html">pyvene.models.basic_utils.get_batch_size</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.basic_utils.get_list_depth.html">pyvene.models.basic_utils.get_list_depth</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.basic_utils.get_type_from_string.html">pyvene.models.basic_utils.get_type_from_string</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.basic_utils.harmonic_sigmoid_boundary.html">pyvene.models.basic_utils.harmonic_sigmoid_boundary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.basic_utils.random_permutation_matrix.html">pyvene.models.basic_utils.random_permutation_matrix</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.basic_utils.set_seed.html">pyvene.models.basic_utils.set_seed</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.basic_utils.sigmoid_boundary.html">pyvene.models.basic_utils.sigmoid_boundary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.basic_utils.top_vals.html">pyvene.models.basic_utils.top_vals</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.blip.html">pyvene.models.blip</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.blip.modelings_blip.html">pyvene.models.blip.modelings_blip</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.blip.modelings_blip_itm.html">pyvene.models.blip.modelings_blip_itm</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.blip.modelings_intervenable_blip.html">pyvene.models.blip.modelings_intervenable_blip</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.blip.modelings_intervenable_blip_itm.html">pyvene.models.blip.modelings_intervenable_blip_itm</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.configuration_intervenable_model.html">pyvene.models.configuration_intervenable_model</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.configuration_intervenable_model.IntervenableConfig.html">pyvene.models.configuration_intervenable_model.IntervenableConfig</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.configuration_intervenable_model.RepresentationConfig.html">pyvene.models.configuration_intervenable_model.RepresentationConfig</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.constants.html">pyvene.models.constants</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.constants.split_and_select.html">pyvene.models.constants.split_and_select</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.constants.split_half.html">pyvene.models.constants.split_half</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.constants.split_head_and_permute.html">pyvene.models.constants.split_head_and_permute</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.constants.split_heads.html">pyvene.models.constants.split_heads</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.constants.split_three.html">pyvene.models.constants.split_three</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.esm.html">pyvene.models.esm</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.esm.modelings_intervenable_esm.html">pyvene.models.esm.modelings_intervenable_esm</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.gemma.html">pyvene.models.gemma</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.gemma.modelings_intervenable_gemma.html">pyvene.models.gemma.modelings_intervenable_gemma</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.gemma2.html">pyvene.models.gemma2</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.gemma2.modelings_intervenable_gemma2.html">pyvene.models.gemma2.modelings_intervenable_gemma2</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.gpt2.html">pyvene.models.gpt2</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.gpt2.modelings_intervenable_gpt2.html">pyvene.models.gpt2.modelings_intervenable_gpt2</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.gpt_neo.html">pyvene.models.gpt_neo</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.gpt_neo.modelings_intervenable_gpt_neo.html">pyvene.models.gpt_neo.modelings_intervenable_gpt_neo</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.gpt_neox.html">pyvene.models.gpt_neox</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.gpt_neox.modelings_intervenable_gpt_neox.html">pyvene.models.gpt_neox.modelings_intervenable_gpt_neox</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.gpt_oss.html">pyvene.models.gpt_oss</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.gpt_oss.modelings_intervenable_gpt_oss.html">pyvene.models.gpt_oss.modelings_intervenable_gpt_oss</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.gru.html">pyvene.models.gru</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.gru.modelings_gru.html">pyvene.models.gru.modelings_gru</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.gru.modelings_intervenable_gru.html">pyvene.models.gru.modelings_intervenable_gru</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.intervenable_base.html">pyvene.models.intervenable_base</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.intervenable_base.build_intervenable_model.html">pyvene.models.intervenable_base.build_intervenable_model</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.intervenable_base.BaseModel.html">pyvene.models.intervenable_base.BaseModel</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.intervenable_base.IntervenableModel.html">pyvene.models.intervenable_base.IntervenableModel</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.intervenable_base.IntervenableModelOutput.html">pyvene.models.intervenable_base.IntervenableModelOutput</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.intervenable_base.IntervenableNdifModel.html">pyvene.models.intervenable_base.IntervenableNdifModel</a></li>
</ul>
</details></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pyvene.models.intervenable_modelcard.html">pyvene.models.intervenable_modelcard</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.intervention_utils.html">pyvene.models.intervention_utils</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.intervention_utils.broadcast_tensor_v1.html">pyvene.models.intervention_utils.broadcast_tensor_v1</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.intervention_utils.broadcast_tensor_v2.html">pyvene.models.intervention_utils.broadcast_tensor_v2</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.intervention_utils.InterventionState.html">pyvene.models.intervention_utils.InterventionState</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.interventions.html">pyvene.models.interventions</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.AdditionIntervention.html">pyvene.models.interventions.AdditionIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.AutoencoderIntervention.html">pyvene.models.interventions.AutoencoderIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.BasisAgnosticIntervention.html">pyvene.models.interventions.BasisAgnosticIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.BoundlessRotatedSpaceIntervention.html">pyvene.models.interventions.BoundlessRotatedSpaceIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.CollectIntervention.html">pyvene.models.interventions.CollectIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.ConstantSourceIntervention.html">pyvene.models.interventions.ConstantSourceIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.DistributedRepresentationIntervention.html">pyvene.models.interventions.DistributedRepresentationIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.Intervention.html">pyvene.models.interventions.Intervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.InterventionOutput.html">pyvene.models.interventions.InterventionOutput</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.JumpReLUAutoencoderIntervention.html">pyvene.models.interventions.JumpReLUAutoencoderIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.LocalistRepresentationIntervention.html">pyvene.models.interventions.LocalistRepresentationIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.LowRankRotatedSpaceIntervention.html">pyvene.models.interventions.LowRankRotatedSpaceIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.NoiseIntervention.html">pyvene.models.interventions.NoiseIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.PCARotatedSpaceIntervention.html">pyvene.models.interventions.PCARotatedSpaceIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.RotatedSpaceIntervention.html">pyvene.models.interventions.RotatedSpaceIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.SharedWeightsTrainableIntervention.html">pyvene.models.interventions.SharedWeightsTrainableIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.SigmoidMaskIntervention.html">pyvene.models.interventions.SigmoidMaskIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.SigmoidMaskRotatedSpaceIntervention.html">pyvene.models.interventions.SigmoidMaskRotatedSpaceIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.SkipIntervention.html">pyvene.models.interventions.SkipIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.SourcelessIntervention.html">pyvene.models.interventions.SourcelessIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.SubtractionIntervention.html">pyvene.models.interventions.SubtractionIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.TrainableIntervention.html">pyvene.models.interventions.TrainableIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.VanillaIntervention.html">pyvene.models.interventions.VanillaIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.ZeroIntervention.html">pyvene.models.interventions.ZeroIntervention</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.layers.html">pyvene.models.layers</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.layers.AutoencoderLayer.html">pyvene.models.layers.AutoencoderLayer</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.layers.AutoencoderLayerBase.html">pyvene.models.layers.AutoencoderLayerBase</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.layers.InverseRotateLayer.html">pyvene.models.layers.InverseRotateLayer</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.layers.LowRankRotateLayer.html">pyvene.models.layers.LowRankRotateLayer</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.layers.RotateLayer.html">pyvene.models.layers.RotateLayer</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.layers.SubspaceLowRankRotateLayer.html">pyvene.models.layers.SubspaceLowRankRotateLayer</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.llama.html">pyvene.models.llama</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.llama.modelings_intervenable_llama.html">pyvene.models.llama.modelings_intervenable_llama</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.llava.html">pyvene.models.llava</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.llava.modelings_intervenable_llava.html">pyvene.models.llava.modelings_intervenable_llava</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.mistral.html">pyvene.models.mistral</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.mistral.modellings_intervenable_mistral.html">pyvene.models.mistral.modellings_intervenable_mistral</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.mllama.html">pyvene.models.mllama</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.mllama.modelings_intervenable_mllama.html">pyvene.models.mllama.modelings_intervenable_mllama</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.mlp.html">pyvene.models.mlp</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.mlp.modelings_intervenable_mlp.html">pyvene.models.mlp.modelings_intervenable_mlp</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.mlp.modelings_mlp.html">pyvene.models.mlp.modelings_mlp</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.html">pyvene.models.modeling_utils</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.b_sd_to_bsd.html">pyvene.models.modeling_utils.b_sd_to_bsd</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.bhsd_to_bs_hd.html">pyvene.models.modeling_utils.bhsd_to_bs_hd</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.bs_hd_to_bhsd.html">pyvene.models.modeling_utils.bs_hd_to_bhsd</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.bsd_to_b_sd.html">pyvene.models.modeling_utils.bsd_to_b_sd</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.do_intervention.html">pyvene.models.modeling_utils.do_intervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.gather_neurons.html">pyvene.models.modeling_utils.gather_neurons</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.get_dimension_by_component.html">pyvene.models.modeling_utils.get_dimension_by_component</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.get_internal_model_type.html">pyvene.models.modeling_utils.get_internal_model_type</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.get_module_hook.html">pyvene.models.modeling_utils.get_module_hook</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.getattr_for_torch_module.html">pyvene.models.modeling_utils.getattr_for_torch_module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.is_gru.html">pyvene.models.modeling_utils.is_gru</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.is_mlp.html">pyvene.models.modeling_utils.is_mlp</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.is_stateless.html">pyvene.models.modeling_utils.is_stateless</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.is_transformer.html">pyvene.models.modeling_utils.is_transformer</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.output_to_subcomponent.html">pyvene.models.modeling_utils.output_to_subcomponent</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.print_forward_hooks.html">pyvene.models.modeling_utils.print_forward_hooks</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.remove_forward_hooks.html">pyvene.models.modeling_utils.remove_forward_hooks</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.scatter_neurons.html">pyvene.models.modeling_utils.scatter_neurons</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.simple_output_to_subcomponent.html">pyvene.models.modeling_utils.simple_output_to_subcomponent</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.simple_scatter_intervention_output.html">pyvene.models.modeling_utils.simple_scatter_intervention_output</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.weighted_average.html">pyvene.models.modeling_utils.weighted_average</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.HandlerList.html">pyvene.models.modeling_utils.HandlerList</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.LambdaIntervention.html">pyvene.models.modeling_utils.LambdaIntervention</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.olmo.html">pyvene.models.olmo</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.olmo.modelings_intervenable_olmo.html">pyvene.models.olmo.modelings_intervenable_olmo</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.olmo2.html">pyvene.models.olmo2</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.olmo2.modelings_intervenable_olmo2.html">pyvene.models.olmo2.modelings_intervenable_olmo2</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.qwen2.html">pyvene.models.qwen2</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.qwen2.modelings_intervenable_qwen2.html">pyvene.models.qwen2.modelings_intervenable_qwen2</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.qwen3.html">pyvene.models.qwen3</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.qwen3.modelings_intervenable_qwen3.html">pyvene.models.qwen3.modelings_intervenable_qwen3</a></li>
</ul>
</details></li>
</ul>
</details></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/tutorials/advanced_tutorials/MQNLI.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Nested Hierarchical Structure with MQNLI</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up">Set-Up</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-mqnli-task">The MQNLI Task</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-mqnli-input">Example MQNLI Input</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mqnli-with-an-intervention">MQNLI with an Intervention</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#training-a-model-on-mqnli">Training a Model on MQNLI</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interpreting-our-model">Interpreting Our Model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluate-das-alignment">Evaluate DAS Alignment</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="nested-hierarchical-structure-with-mqnli">
<h1>Nested Hierarchical Structure with MQNLI<a class="headerlink" href="#nested-hierarchical-structure-with-mqnli" title="Link to this heading">#</a></h1>
<p>In this notebook, we use <code class="docutils literal notranslate"><span class="pre">pyvene</span></code> to analyze language models on a complex heirarchical task: multiply-quantified natural language inference (MQNLI).
We begin by describing the causal structure that generates our data through semantic composition. Then, we analyze whether models that learn this task employ the same compositional structure to solve it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Amir Zur&quot;</span>
</pre></div>
</div>
</div>
</div>
<section id="set-up">
<h2>Set-Up<a class="headerlink" href="#set-up" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
<span class="kn">import</span> <span class="nn">pyvene</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span> 
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span><span class="p">,</span> <span class="n">trange</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch.nn</span> <span class="kn">import</span> <span class="n">CrossEntropyLoss</span>
<span class="kn">from</span> <span class="nn">torch.utils.data</span> <span class="kn">import</span> <span class="n">DataLoader</span>
<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">TrainingArguments</span><span class="p">,</span> <span class="n">Trainer</span>
<span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span>

<span class="kn">from</span> <span class="nn">pyvene</span> <span class="kn">import</span> <span class="n">CausalModel</span>
<span class="c1"># from pyvene.models.configuration_intervenable_model import RepresentationConfig</span>
<span class="kn">from</span> <span class="nn">pyvene</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">IntervenableModel</span><span class="p">,</span>
    <span class="n">RotatedSpaceIntervention</span><span class="p">,</span>
    <span class="n">RepresentationConfig</span><span class="p">,</span>
    <span class="n">IntervenableConfig</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">pyvene.models.gpt2.modelings_intervenable_gpt2</span> <span class="kn">import</span> <span class="n">create_gpt2_lm</span>
<span class="c1"># from pyvene.models.gpt_neox.modelings_intervenable_gpt_neox import create_gpt_neox</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">TRAIN_DIR</span> <span class="o">=</span> <span class="s1">&#39;mqnli_factual&#39;</span>
<span class="n">DAS_DIR</span> <span class="o">=</span> <span class="s1">&#39;mqnli_das&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">seed</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
<span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
<span class="n">torch</span><span class="o">.</span><span class="n">manual_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;torch._C.Generator at 0x169a1e510b0&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="the-mqnli-task">
<h2>The MQNLI Task<a class="headerlink" href="#the-mqnli-task" title="Link to this heading">#</a></h2>
<p>Multiply-quantified natural language inference (MQNLI) is a variant of natural language inference (NLI) with a highly structured composition. Each datapoint is a pair of sentences, and each label is the logical relation between them (e.g., entailment, reverse entailment, no relation). Crucially, the logical relation can be computed compositionally: first compute the relation between the two sentences’ nouns, then their determiners, and then combine these intermediate computations to find the relation between the sentences’ noun phrases (NPs).</p>
<p>In this section, we walk through the high-level causal structure of MQNLI with examples from the MQNLI dataset. We encourage first-time readers to read the original paper, <a class="reference external" href="https://arxiv.org/pdf/1810.13033.pdf">Geiger, Cases, Karttunen, and Potts (2018)</a>, before getting started.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># JSON files generated from adapting MQNLI codebase</span>
<span class="c1"># https://github.com/atticusg/MultiplyQuantifiedData</span>

<span class="k">class</span> <span class="nc">Hashabledict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">frozenset</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;tutorial_data/mqnli_q_projectivity.json&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">determiner_signatures</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">determiner_signatures</span> <span class="o">=</span> <span class="n">Hashabledict</span><span class="p">({</span>
        <span class="n">q1</span><span class="p">:</span> <span class="n">Hashabledict</span><span class="p">({</span>
            <span class="n">q2</span><span class="p">:</span> <span class="n">Hashabledict</span><span class="p">({</span>
                <span class="n">r1</span><span class="p">:</span> <span class="n">Hashabledict</span><span class="p">({</span>
                    <span class="n">r2</span><span class="p">:</span> <span class="n">determiner_signatures</span><span class="p">[</span><span class="n">q1</span><span class="p">][</span><span class="n">q2</span><span class="p">][</span><span class="n">r1</span><span class="p">][</span><span class="n">r2</span><span class="p">]</span>  
                    <span class="k">for</span> <span class="n">r2</span> <span class="ow">in</span> <span class="n">determiner_signatures</span><span class="p">[</span><span class="n">q1</span><span class="p">][</span><span class="n">q2</span><span class="p">][</span><span class="n">r1</span><span class="p">]</span>
                <span class="p">})</span>  
                <span class="k">for</span> <span class="n">r1</span> <span class="ow">in</span> <span class="n">determiner_signatures</span><span class="p">[</span><span class="n">q1</span><span class="p">][</span><span class="n">q2</span><span class="p">]</span>
            <span class="p">})</span>
            <span class="k">for</span> <span class="n">q2</span> <span class="ow">in</span> <span class="n">determiner_signatures</span><span class="p">[</span><span class="n">q1</span><span class="p">]</span>
        <span class="p">})</span>
        <span class="k">for</span> <span class="n">q1</span> <span class="ow">in</span> <span class="n">determiner_signatures</span>
    <span class="p">})</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;tutorial_data/mqnli_neg_signature.json&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">negation_signature</span> <span class="o">=</span> <span class="n">Hashabledict</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;tutorial_data/mqnli_empty_signature.json&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">emptystring_signature</span> <span class="o">=</span> <span class="n">Hashabledict</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;tutorial_data/mqnli_cont_signature.json&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">compose_contradiction_signature</span> <span class="o">=</span> <span class="n">Hashabledict</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;tutorial_data/mqnli_neg_cont_signature.json&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">compose_neg_contradiction_signature</span> <span class="o">=</span> <span class="n">Hashabledict</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">parents</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;N_P_O&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;N_H_O&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;N_O&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;N_P_O&quot;</span><span class="p">,</span> <span class="s2">&quot;N_H_O&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Adj_P_O&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;Adj_H_O&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;Adj_O&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Adj_P_O&quot;</span><span class="p">,</span> <span class="s2">&quot;Adj_H_O&quot;</span><span class="p">],</span>
    <span class="s2">&quot;NP_O&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Adj_O&quot;</span><span class="p">,</span> <span class="s2">&quot;N_O&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Q_P_O&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;Q_H_O&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;Q_O&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Q_P_O&quot;</span><span class="p">,</span> <span class="s2">&quot;Q_H_O&quot;</span><span class="p">],</span>
    <span class="s2">&quot;V_P&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;V_H&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;V&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;V_P&quot;</span><span class="p">,</span> <span class="s2">&quot;V_H&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Adv_P&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;Adv_H&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;Adv&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Adv_P&quot;</span><span class="p">,</span> <span class="s2">&quot;Adv_H&quot;</span><span class="p">],</span>
    <span class="s2">&quot;VP&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Adv&quot;</span><span class="p">,</span> <span class="s2">&quot;V&quot;</span><span class="p">],</span>
    <span class="s2">&quot;QP_O&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Q_O&quot;</span><span class="p">,</span> <span class="s2">&quot;NP_O&quot;</span><span class="p">,</span> <span class="s2">&quot;VP&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Neg_P&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;Neg_H&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;Neg&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Neg_P&quot;</span><span class="p">,</span> <span class="s2">&quot;Neg_H&quot;</span><span class="p">],</span>
    <span class="s2">&quot;NegP&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Neg&quot;</span><span class="p">,</span> <span class="s2">&quot;QP_O&quot;</span><span class="p">],</span>
    <span class="s2">&quot;N_P_S&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;N_H_S&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;N_S&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;N_P_S&quot;</span><span class="p">,</span> <span class="s2">&quot;N_H_S&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Adj_P_S&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;Adj_H_S&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;Adj_S&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Adj_P_S&quot;</span><span class="p">,</span> <span class="s2">&quot;Adj_H_S&quot;</span><span class="p">],</span>
    <span class="s2">&quot;NP_S&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Adj_S&quot;</span><span class="p">,</span> <span class="s2">&quot;N_S&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Q_P_S&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;Q_H_S&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;Q_S&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Q_P_S&quot;</span><span class="p">,</span> <span class="s2">&quot;Q_H_S&quot;</span><span class="p">],</span>
    <span class="s2">&quot;QP_S&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Q_S&quot;</span><span class="p">,</span> <span class="s2">&quot;NP_S&quot;</span><span class="p">,</span> <span class="s2">&quot;NegP&quot;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">EMPTY</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="n">IND</span> <span class="o">=</span> <span class="s2">&quot;independence&quot;</span>
<span class="n">EQV</span> <span class="o">=</span> <span class="s2">&quot;equivalence&quot;</span>
<span class="n">ENT</span> <span class="o">=</span> <span class="s2">&quot;entails&quot;</span>
<span class="n">REV</span> <span class="o">=</span> <span class="s2">&quot;reverse entails&quot;</span>
<span class="n">CON</span> <span class="o">=</span> <span class="s2">&quot;contradiction&quot;</span>
<span class="n">ALT</span> <span class="o">=</span> <span class="s2">&quot;alternation&quot;</span>
<span class="n">COV</span> <span class="o">=</span> <span class="s2">&quot;cover&quot;</span>
<span class="c1"># all possible relation values from the original paper </span>
<span class="c1"># (https://arxiv.org/pdf/1810.13033.pdf)</span>
<span class="n">RELATIONS</span> <span class="o">=</span> <span class="p">[</span><span class="n">IND</span><span class="p">,</span> <span class="n">EQV</span><span class="p">,</span> <span class="n">ENT</span><span class="p">,</span> <span class="n">REV</span><span class="p">,</span> <span class="n">CON</span><span class="p">,</span> <span class="n">ALT</span><span class="p">,</span> <span class="n">COV</span><span class="p">]</span>

<span class="n">Q_VALUES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">determiner_signatures</span><span class="p">[</span><span class="n">q1</span><span class="p">][</span><span class="n">q2</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">q1</span> <span class="ow">in</span> <span class="n">determiner_signatures</span> <span class="k">for</span> <span class="n">q2</span> <span class="ow">in</span> <span class="n">determiner_signatures</span><span class="p">[</span><span class="n">q1</span><span class="p">]</span>
<span class="p">]</span>

<span class="n">values</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;N_P_O&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;tree&quot;</span><span class="p">,</span> <span class="s2">&quot;rock&quot;</span><span class="p">],</span>
    <span class="s2">&quot;N_H_O&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;tree&quot;</span><span class="p">,</span> <span class="s2">&quot;rock&quot;</span><span class="p">],</span>
    <span class="s2">&quot;N_O&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">EQV</span><span class="p">,</span> <span class="n">IND</span><span class="p">],</span>
    <span class="s2">&quot;Adj_P_O&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;happy&quot;</span><span class="p">,</span> <span class="s2">&quot;sad&quot;</span><span class="p">,</span> <span class="n">EMPTY</span><span class="p">],</span>
    <span class="s2">&quot;Adj_H_O&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;happy&quot;</span><span class="p">,</span> <span class="s2">&quot;sad&quot;</span><span class="p">,</span> <span class="n">EMPTY</span><span class="p">],</span>
    <span class="s2">&quot;Adj_O&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">EQV</span><span class="p">,</span> <span class="n">IND</span><span class="p">,</span> <span class="n">ENT</span><span class="p">,</span> <span class="n">REV</span><span class="p">],</span>
    <span class="s2">&quot;NP_O&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">EQV</span><span class="p">,</span> <span class="n">IND</span><span class="p">,</span> <span class="n">ENT</span><span class="p">,</span> <span class="n">REV</span><span class="p">],</span>
    <span class="s2">&quot;Q_P_O&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;some&quot;</span><span class="p">,</span> <span class="s2">&quot;every&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Q_H_O&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;some&quot;</span><span class="p">,</span> <span class="s2">&quot;every&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Q_O&quot;</span><span class="p">:</span> <span class="n">Q_VALUES</span><span class="p">,</span>
    <span class="s2">&quot;V_P&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;climbed&quot;</span><span class="p">,</span> <span class="s2">&quot;threw&quot;</span><span class="p">],</span>
    <span class="s2">&quot;V_H&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;climbed&quot;</span><span class="p">,</span> <span class="s2">&quot;threw&quot;</span><span class="p">],</span>
    <span class="s2">&quot;V&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">EQV</span><span class="p">,</span> <span class="n">IND</span><span class="p">],</span>
    <span class="s2">&quot;Adv_P&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;energetically&quot;</span><span class="p">,</span> <span class="s2">&quot;joyfully&quot;</span><span class="p">,</span> <span class="n">EMPTY</span><span class="p">],</span>
    <span class="s2">&quot;Adv_H&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;energetically&quot;</span><span class="p">,</span> <span class="s2">&quot;joyfully&quot;</span><span class="p">,</span> <span class="n">EMPTY</span><span class="p">],</span>
    <span class="s2">&quot;Adv&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">EQV</span><span class="p">,</span> <span class="n">IND</span><span class="p">,</span> <span class="n">ENT</span><span class="p">,</span> <span class="n">REV</span><span class="p">],</span>
    <span class="s2">&quot;VP&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">EQV</span><span class="p">,</span> <span class="n">IND</span><span class="p">,</span> <span class="n">ENT</span><span class="p">,</span> <span class="n">REV</span><span class="p">],</span>
    <span class="s2">&quot;QP_O&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">EQV</span><span class="p">,</span> <span class="n">IND</span><span class="p">,</span> <span class="n">ENT</span><span class="p">,</span> <span class="n">REV</span><span class="p">],</span>
    <span class="s2">&quot;Neg_P&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;not&quot;</span><span class="p">,</span> <span class="n">EMPTY</span><span class="p">],</span>
    <span class="s2">&quot;Neg_H&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;not&quot;</span><span class="p">,</span> <span class="n">EMPTY</span><span class="p">],</span>
    <span class="s2">&quot;Neg&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">negation_signature</span><span class="p">,</span> 
        <span class="n">emptystring_signature</span><span class="p">,</span> 
        <span class="n">compose_contradiction_signature</span><span class="p">,</span> 
        <span class="n">compose_neg_contradiction_signature</span>
    <span class="p">],</span>
    <span class="s2">&quot;NegP&quot;</span><span class="p">:</span> <span class="n">RELATIONS</span><span class="p">,</span>
    <span class="s2">&quot;N_P_S&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;child&quot;</span><span class="p">,</span> <span class="s2">&quot;dog&quot;</span><span class="p">],</span>
    <span class="s2">&quot;N_H_S&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;child&quot;</span><span class="p">,</span> <span class="s2">&quot;dog&quot;</span><span class="p">],</span>
    <span class="s2">&quot;N_S&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">EQV</span><span class="p">,</span> <span class="n">IND</span><span class="p">],</span>
    <span class="s2">&quot;Adj_P_S&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;little&quot;</span><span class="p">,</span> <span class="s2">&quot;cute&quot;</span><span class="p">,</span> <span class="n">EMPTY</span><span class="p">],</span>
    <span class="s2">&quot;Adj_H_S&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;little&quot;</span><span class="p">,</span> <span class="s2">&quot;cute&quot;</span><span class="p">,</span> <span class="n">EMPTY</span><span class="p">],</span>
    <span class="s2">&quot;Adj_S&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">EQV</span><span class="p">,</span> <span class="n">IND</span><span class="p">,</span> <span class="n">ENT</span><span class="p">,</span> <span class="n">REV</span><span class="p">],</span>
    <span class="s2">&quot;NP_S&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">EQV</span><span class="p">,</span> <span class="n">IND</span><span class="p">,</span> <span class="n">ENT</span><span class="p">,</span> <span class="n">REV</span><span class="p">],</span>
    <span class="s2">&quot;Q_P_S&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;some&quot;</span><span class="p">,</span> <span class="s2">&quot;every&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Q_H_S&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;some&quot;</span><span class="p">,</span> <span class="s2">&quot;every&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Q_S&quot;</span><span class="p">:</span> <span class="n">Q_VALUES</span><span class="p">,</span>
    <span class="s2">&quot;QP_S&quot;</span><span class="p">:</span> <span class="n">RELATIONS</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># adapted from original code for MQNLI:</span>
<span class="c1"># https://github.com/atticusg/MultiplyQuantifiedData/blob/master/natural_logic_model.py</span>

<span class="k">def</span> <span class="nf">adj_merge</span><span class="p">(</span><span class="n">adj_p</span><span class="p">,</span> <span class="n">adj_h</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">adj_p</span> <span class="o">==</span> <span class="n">adj_h</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">EQV</span>
    <span class="k">if</span> <span class="n">adj_p</span> <span class="o">==</span> <span class="n">EMPTY</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">REV</span>
    <span class="k">if</span> <span class="n">adj_h</span> <span class="o">==</span> <span class="n">EMPTY</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ENT</span>
    <span class="k">return</span> <span class="n">IND</span>

<span class="n">adv_merge</span> <span class="o">=</span> <span class="n">adj_merge</span>

<span class="k">def</span> <span class="nf">noun_phrase</span><span class="p">(</span><span class="n">adj</span><span class="p">,</span> <span class="n">noun</span><span class="p">):</span>
    <span class="c1">#merges a noun relation with an adjective relation</span>
    <span class="c1">#or a verb relation with an adverb relation</span>
    <span class="c1"># makes sense: if the objects are the same, then adjective&#39;s relation holds</span>
    <span class="c1"># otherwise, they&#39;re independent</span>
    <span class="k">if</span> <span class="n">noun</span> <span class="o">==</span> <span class="n">EQV</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">adj</span>
    <span class="k">return</span> <span class="n">IND</span>

<span class="n">verb_phrase</span> <span class="o">=</span> <span class="n">noun_phrase</span>

<span class="k">def</span> <span class="nf">negation_merge</span><span class="p">(</span><span class="n">neg_p</span><span class="p">,</span> <span class="n">neg_h</span><span class="p">):</span>
    <span class="c1">#merges negation</span>
    <span class="k">if</span> <span class="n">neg_p</span> <span class="o">==</span> <span class="n">neg_h</span> <span class="ow">and</span> <span class="n">neg_p</span> <span class="o">==</span> <span class="n">EMPTY</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Hashabledict</span><span class="p">(</span><span class="n">emptystring_signature</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">neg_p</span> <span class="o">==</span> <span class="n">neg_h</span> <span class="ow">and</span> <span class="n">neg_p</span> <span class="o">!=</span> <span class="n">EMPTY</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Hashabledict</span><span class="p">(</span><span class="n">negation_signature</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">neg_p</span> <span class="o">==</span> <span class="n">EMPTY</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Hashabledict</span><span class="p">(</span><span class="n">compose_contradiction_signature</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">neg_p</span> <span class="o">!=</span> <span class="n">EMPTY</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Hashabledict</span><span class="p">(</span><span class="n">compose_neg_contradiction_signature</span><span class="p">)</span>

<span class="n">negation_phrase</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">neg</span><span class="p">,</span> <span class="n">qp</span><span class="p">:</span> <span class="n">neg</span><span class="p">[</span><span class="n">qp</span><span class="p">]</span>

<span class="n">noun_merge</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">n_p</span><span class="p">,</span> <span class="n">n_h</span><span class="p">:</span> <span class="n">EQV</span> <span class="k">if</span> <span class="n">n_p</span> <span class="o">==</span> <span class="n">n_h</span> <span class="k">else</span> <span class="n">IND</span>
<span class="n">verb_merge</span> <span class="o">=</span> <span class="n">noun_merge</span>

<span class="n">quantifier_merge</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">q_p</span><span class="p">,</span> <span class="n">q_h</span><span class="p">:</span> <span class="n">determiner_signatures</span><span class="p">[</span><span class="n">q_p</span><span class="p">][</span><span class="n">q_h</span><span class="p">]</span>

<span class="n">quantifier_phrase</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">q</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">vp</span><span class="p">:</span> <span class="n">q</span><span class="p">[</span><span class="n">np</span><span class="p">][</span><span class="n">vp</span><span class="p">]</span>

<span class="n">functions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;N_P_O&quot;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="s2">&quot;tree&quot;</span><span class="p">,</span>
    <span class="s2">&quot;N_H_O&quot;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="s2">&quot;tree&quot;</span><span class="p">,</span>
    <span class="s2">&quot;N_O&quot;</span><span class="p">:</span> <span class="n">noun_merge</span><span class="p">,</span>
    <span class="s2">&quot;Adj_P_O&quot;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="s2">&quot;happy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Adj_H_O&quot;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="s2">&quot;happy&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Adj_O&quot;</span><span class="p">:</span> <span class="n">adj_merge</span><span class="p">,</span>
    <span class="s2">&quot;NP_O&quot;</span><span class="p">:</span> <span class="n">noun_phrase</span><span class="p">,</span>
    <span class="s2">&quot;Q_P_O&quot;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="s2">&quot;some&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Q_H_O&quot;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="s2">&quot;some&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Q_O&quot;</span><span class="p">:</span> <span class="n">quantifier_merge</span><span class="p">,</span>
    <span class="s2">&quot;V_P&quot;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="s2">&quot;climbed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;V_H&quot;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="s2">&quot;climbed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;V&quot;</span><span class="p">:</span> <span class="n">verb_merge</span><span class="p">,</span>
    <span class="s2">&quot;Adv_P&quot;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="s2">&quot;energetically&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Adv_H&quot;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="s2">&quot;energetically&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Adv&quot;</span><span class="p">:</span> <span class="n">adv_merge</span><span class="p">,</span>
    <span class="s2">&quot;VP&quot;</span><span class="p">:</span> <span class="n">verb_phrase</span><span class="p">,</span>
    <span class="s2">&quot;QP_O&quot;</span><span class="p">:</span> <span class="n">quantifier_phrase</span><span class="p">,</span>
    <span class="s2">&quot;Neg_P&quot;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="s2">&quot;not&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Neg_H&quot;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="s2">&quot;not&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Neg&quot;</span><span class="p">:</span> <span class="n">negation_merge</span><span class="p">,</span>
    <span class="s2">&quot;NegP&quot;</span><span class="p">:</span> <span class="n">negation_phrase</span><span class="p">,</span>
    <span class="s2">&quot;N_P_S&quot;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="s2">&quot;dog&quot;</span><span class="p">,</span>
    <span class="s2">&quot;N_H_S&quot;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="s2">&quot;dog&quot;</span><span class="p">,</span>
    <span class="s2">&quot;N_S&quot;</span><span class="p">:</span> <span class="n">noun_merge</span><span class="p">,</span>
    <span class="s2">&quot;Adj_P_S&quot;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="s2">&quot;cute&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Adj_H_S&quot;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="s2">&quot;cute&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Adj_S&quot;</span><span class="p">:</span> <span class="n">adj_merge</span><span class="p">,</span>
    <span class="s2">&quot;NP_S&quot;</span><span class="p">:</span> <span class="n">noun_phrase</span><span class="p">,</span>
    <span class="s2">&quot;Q_P_S&quot;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="s2">&quot;some&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Q_H_S&quot;</span><span class="p">:</span> <span class="k">lambda</span><span class="p">:</span> <span class="s2">&quot;some&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Q_S&quot;</span><span class="p">:</span> <span class="n">quantifier_merge</span><span class="p">,</span>
    <span class="s2">&quot;QP_S&quot;</span><span class="p">:</span> <span class="n">quantifier_phrase</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># coordinates to display the MQNLI tree</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;N_P_O&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">),</span>
    <span class="s2">&quot;N_H_O&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">),</span>
    <span class="s2">&quot;N_O&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">31</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">),</span>
    <span class="s2">&quot;Adj_P_O&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s2">&quot;Adj_H_O&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">26</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
    <span class="s2">&quot;Adj_O&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">27</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="s2">&quot;NP_O&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">29</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="s2">&quot;Q_P_O&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">),</span>
    <span class="s2">&quot;Q_H_O&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">),</span>
    <span class="s2">&quot;Q_O&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span>
    <span class="s2">&quot;V_P&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
    <span class="s2">&quot;V_H&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
    <span class="s2">&quot;V&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="s2">&quot;Adv_P&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">),</span>
    <span class="s2">&quot;Adv_H&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span>
    <span class="s2">&quot;Adv&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">),</span>
    <span class="s2">&quot;VP&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="s2">&quot;QP_O&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="s2">&quot;Neg_P&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span>
    <span class="s2">&quot;Neg_H&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="s2">&quot;Neg&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">),</span>
    <span class="s2">&quot;NegP&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
    <span class="s2">&quot;N_P_S&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">),</span>
    <span class="s2">&quot;N_H_S&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mf">2.8</span><span class="p">),</span>
    <span class="s2">&quot;N_S&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mf">3.3</span><span class="p">),</span>
    <span class="s2">&quot;Adj_P_S&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">),</span>
    <span class="s2">&quot;Adj_H_S&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="s2">&quot;Adj_S&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span>
    <span class="s2">&quot;NP_S&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mf">4.3</span><span class="p">),</span>
    <span class="s2">&quot;Q_P_S&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mf">3.2</span><span class="p">),</span>
    <span class="s2">&quot;Q_H_S&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">),</span>
    <span class="s2">&quot;Q_S&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
    <span class="s2">&quot;QP_S&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">variables</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">parents</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>  <span class="c1"># pretty sure this preserves order?</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mqlni_model</span> <span class="o">=</span> <span class="n">CausalModel</span><span class="p">(</span><span class="n">variables</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">parents</span><span class="p">,</span> <span class="n">functions</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We begin by visualizing the high-level structure of the MQNLI task. All leaf nodes consist of text entries (e.g., Adj_P_O might be “fun”, N_H_O might be “child”), with one copy corresponding to the premise sentence (P) and the other corresponding to the hypothesis (H). All other nodes take on relation values (e.g., entailment, reverse entailment, no relation), or mappings between relations (e.g., (entailment, entailment) –&gt; no entailment).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mqlni_model</span><span class="o">.</span><span class="n">print_structure</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/d1c6b90794f1c5c0fcfa0931492742db78295ea701f49c67bfe4f5609cebd96a.png" src="../../_images/d1c6b90794f1c5c0fcfa0931492742db78295ea701f49c67bfe4f5609cebd96a.png" />
</div>
</div>
<section id="example-mqnli-input">
<h3>Example MQNLI Input<a class="headerlink" href="#example-mqnli-input" title="Link to this heading">#</a></h3>
<p>Here we walk through an example MQNLI input, presented below.</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="err">Premise</span><span class="p">:</span><span class="w"> </span><span class="err">Every</span><span class="w"> </span><span class="err">dog</span><span class="w"> </span><span class="err">climbed</span><span class="w"> </span><span class="err">some</span><span class="w"> </span><span class="kc">tree</span><span class="err">.</span>
<span class="err">Hypo</span><span class="kc">t</span><span class="err">hesis</span><span class="p">:</span><span class="w"> </span><span class="err">Some</span><span class="w"> </span><span class="err">dog</span><span class="w"> </span><span class="err">did</span><span class="w"> </span><span class="kc">n</span><span class="err">o</span><span class="kc">t</span><span class="w"> </span><span class="err">climb</span><span class="w"> </span><span class="err">every</span><span class="w"> </span><span class="kc">tree</span><span class="err">.</span>
</pre></div>
</div>
<p>The output for this sentence pair is <code class="docutils literal notranslate"><span class="pre">contradiction</span></code>, because the premise entails that there cannot be a dog who climbed no tree.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># premise</span>
    <span class="s2">&quot;Q_P_S&quot;</span><span class="p">:</span> <span class="s2">&quot;every&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Adj_P_S&quot;</span><span class="p">:</span> <span class="n">EMPTY</span><span class="p">,</span>
    <span class="s2">&quot;N_P_S&quot;</span><span class="p">:</span> <span class="s2">&quot;dog&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Neg_P&quot;</span><span class="p">:</span> <span class="n">EMPTY</span><span class="p">,</span>
    <span class="s2">&quot;Adv_P&quot;</span><span class="p">:</span> <span class="n">EMPTY</span><span class="p">,</span>
    <span class="s2">&quot;V_P&quot;</span><span class="p">:</span> <span class="s2">&quot;climbed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Q_P_O&quot;</span><span class="p">:</span> <span class="s2">&quot;some&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Adj_P_O&quot;</span><span class="p">:</span> <span class="n">EMPTY</span><span class="p">,</span>
    <span class="s2">&quot;N_P_O&quot;</span><span class="p">:</span> <span class="s2">&quot;tree&quot;</span><span class="p">,</span>
    <span class="c1"># hypothesis</span>
    <span class="s2">&quot;Q_H_S&quot;</span><span class="p">:</span> <span class="s2">&quot;some&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Adj_H_S&quot;</span><span class="p">:</span> <span class="n">EMPTY</span><span class="p">,</span>
    <span class="s2">&quot;N_H_S&quot;</span><span class="p">:</span> <span class="s2">&quot;dog&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Neg_H&quot;</span><span class="p">:</span> <span class="s2">&quot;not&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Adv_H&quot;</span><span class="p">:</span> <span class="n">EMPTY</span><span class="p">,</span>
    <span class="s2">&quot;V_H&quot;</span><span class="p">:</span> <span class="s2">&quot;climbed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Q_H_O&quot;</span><span class="p">:</span> <span class="s2">&quot;some&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Adj_H_O&quot;</span><span class="p">:</span> <span class="n">EMPTY</span><span class="p">,</span>
    <span class="s2">&quot;N_H_O&quot;</span><span class="p">:</span> <span class="s2">&quot;tree&quot;</span>
<span class="p">}</span>

<span class="n">setting</span> <span class="o">=</span> <span class="n">mqlni_model</span><span class="o">.</span><span class="n">run_forward</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">print_premise</span><span class="p">(</span><span class="n">setting</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;Q_P_S&quot;</span><span class="p">],</span>
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;Adj_P_S&quot;</span><span class="p">],</span>
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;N_P_S&quot;</span><span class="p">],</span>
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;Neg_P&quot;</span><span class="p">],</span>
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;Adv_P&quot;</span><span class="p">],</span>
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;V_P&quot;</span><span class="p">],</span>
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;Q_P_O&quot;</span><span class="p">],</span>
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;Adj_P_O&quot;</span><span class="p">],</span>
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;N_P_O&quot;</span><span class="p">]</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">print_hypothesis</span><span class="p">(</span><span class="n">setting</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;Q_H_S&quot;</span><span class="p">],</span>
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;Adj_H_S&quot;</span><span class="p">],</span>
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;N_H_S&quot;</span><span class="p">],</span>
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;Neg_H&quot;</span><span class="p">],</span>
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;Adv_H&quot;</span><span class="p">],</span>
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;V_H&quot;</span><span class="p">],</span>
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;Q_H_O&quot;</span><span class="p">],</span>
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;Adj_H_O&quot;</span><span class="p">],</span>
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;N_H_O&quot;</span><span class="p">]</span>
    <span class="p">)</span>

<span class="n">print_premise</span><span class="p">(</span><span class="n">setting</span><span class="p">)</span>
<span class="n">print_hypothesis</span><span class="p">(</span><span class="n">setting</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">setting</span><span class="p">[</span><span class="s2">&quot;QP_S&quot;</span><span class="p">])</span> <span class="c1"># the output is in the root node, QP_S</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>every  dog   climbed some  tree
some  dog not  climbed some  tree
contradiction
</pre></div>
</div>
</div>
</div>
<p>We display the structure of the MQNLI example below. Note that the intermediate relation values compose with each other to produce the final output. For instance, since <code class="docutils literal notranslate"><span class="pre">N_O</span></code> and <code class="docutils literal notranslate"><span class="pre">Adj_O</span></code> both take on the value <code class="docutils literal notranslate"><span class="pre">equivalence</span></code>, then <code class="docutils literal notranslate"><span class="pre">NP_O</span></code> is also an equivalence relation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">}</span>
<span class="n">mqlni_model</span><span class="o">.</span><span class="n">print_setting</span><span class="p">(</span><span class="n">setting</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="n">display</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/47c576c6625384e231a4e0bd6c52e5721c4b4d45373b16378e3fa9f1508d6107.png" src="../../_images/47c576c6625384e231a4e0bd6c52e5721c4b4d45373b16378e3fa9f1508d6107.png" />
</div>
</div>
</section>
<section id="mqnli-with-an-intervention">
<h3>MQNLI with an Intervention<a class="headerlink" href="#mqnli-with-an-intervention" title="Link to this heading">#</a></h3>
<p>Below is a run of the MQNLI logic model where we intervene on the object quantifier (<code class="docutils literal notranslate"><span class="pre">QP_O</span></code>) and swap its relation value from <code class="docutils literal notranslate"><span class="pre">equivalence</span></code> to <code class="docutils literal notranslate"><span class="pre">contradiction</span></code>. Note that this changes the final output from <code class="docutils literal notranslate"><span class="pre">contradiction</span></code> to <code class="docutils literal notranslate"><span class="pre">entailment</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">intervention</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">inputs</span><span class="p">,</span> <span class="s1">&#39;QP_O&#39;</span><span class="p">:</span> <span class="s1">&#39;contradiction&#39;</span><span class="p">}</span>
<span class="n">setting</span> <span class="o">=</span> <span class="n">mqlni_model</span><span class="o">.</span><span class="n">run_forward</span><span class="p">(</span><span class="n">intervention</span><span class="p">)</span>
<span class="n">print_premise</span><span class="p">(</span><span class="n">setting</span><span class="p">)</span>
<span class="n">print_hypothesis</span><span class="p">(</span><span class="n">setting</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">setting</span><span class="p">[</span><span class="s2">&quot;QP_S&quot;</span><span class="p">])</span>

<span class="n">mqlni_model</span><span class="o">.</span><span class="n">print_setting</span><span class="p">(</span><span class="n">setting</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="n">display</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>every  dog   climbed some  tree
some  dog not  climbed some  tree
entails
</pre></div>
</div>
<img alt="../../_images/510186486f21246350da9fca871ec45a7cc4552e2185e3dccc90f2fde4ff0a8b.png" src="../../_images/510186486f21246350da9fca871ec45a7cc4552e2185e3dccc90f2fde4ff0a8b.png" />
</div>
</div>
</section>
</section>
<section id="training-a-model-on-mqnli">
<h2>Training a Model on MQNLI<a class="headerlink" href="#training-a-model-on-mqnli" title="Link to this heading">#</a></h2>
<p>In this section, we train a language model (GPT-2) on the MQNLI task. Importantly, we do not need to access the original MQNLI dataset to do this – having set up our causal model earlier in this notebook, we can generate datapoints by sampling from it directly!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset</span> <span class="o">=</span> <span class="n">mqlni_model</span><span class="o">.</span><span class="n">generate_factual_dataset</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">mqlni_model</span><span class="o">.</span><span class="n">sample_input_tree_balanced</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">example</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">example</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">print_premise</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">print_hypothesis</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;QP_S&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>some little child  energetically climbed some happy tree
every  child not energetically climbed some happy tree
alternation
</pre></div>
</div>
</div>
</div>
<p>We want to make sure that we indeed sampled evenly from the causal structure. For now, we can just verify that every possible output value (i.e., the values of the root node <code class="docutils literal notranslate"><span class="pre">QP_S</span></code>) has enough datapoints.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Counter</span><span class="p">([</span><span class="n">n</span><span class="p">[</span><span class="s1">&#39;QP_S&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">y</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Counter({&#39;alternation&#39;: 16,
         &#39;contradiction&#39;: 18,
         &#39;reverse entails&#39;: 15,
         &#39;independence&#39;: 14,
         &#39;entails&#39;: 16,
         &#39;equivalence&#39;: 10,
         &#39;cover&#39;: 11})
</pre></div>
</div>
</div>
</div>
<p>Time to train a language model!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">model</span> <span class="o">=</span> <span class="n">create_gpt2_lm</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>loaded model
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">premise_to_string</span><span class="p">(</span><span class="n">setting</span><span class="p">):</span>
    <span class="k">return</span> \
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;Q_P_S&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> \
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;Adj_P_S&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> \
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;N_P_S&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> \
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;Neg_P&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> \
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;Adv_P&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> \
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;V_P&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> \
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;Q_P_O&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> \
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;Adj_P_O&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> \
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;N_P_O&quot;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">hypothesis_to_string</span><span class="p">(</span><span class="n">setting</span><span class="p">):</span>
    <span class="k">return</span> \
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;Q_H_S&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> \
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;Adj_H_S&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> \
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;N_H_S&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> \
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;Neg_H&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> \
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;Adv_H&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> \
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;V_H&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> \
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;Q_H_O&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> \
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;Adj_H_O&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> \
        <span class="n">setting</span><span class="p">[</span><span class="s2">&quot;N_H_O&quot;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">preprocess_input</span><span class="p">(</span><span class="n">setting</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;Premise: </span><span class="si">{</span><span class="n">premise_to_string</span><span class="p">(</span><span class="n">setting</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">Hypothesis: </span><span class="si">{</span><span class="n">hypothesis_to_string</span><span class="p">(</span><span class="n">setting</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">Relation: &#39;</span>

<span class="k">def</span> <span class="nf">preprocess_output</span><span class="p">(</span><span class="n">setting</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">setting</span><span class="p">[</span><span class="s1">&#39;QP_S&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">IGNORE_INDEX</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span>
<span class="n">MAX_LENGTH</span> <span class="o">=</span> <span class="mi">64</span>

<span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token</span>

<span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">examples</span> <span class="o">=</span> <span class="p">[</span><span class="n">preprocess_input</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">X</span><span class="p">]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">preprocess_output</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">y</span><span class="p">]</span>

    <span class="n">examples</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">(</span>
        <span class="n">examples</span><span class="p">,</span> 
        <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;max_length&#39;</span><span class="p">,</span> 
        <span class="n">max_length</span><span class="o">=</span><span class="n">MAX_LENGTH</span><span class="p">,</span> 
        <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
        <span class="n">return_tensors</span><span class="o">=</span><span class="s1">&#39;pt&#39;</span>
    <span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">(</span>
        <span class="n">labels</span><span class="p">,</span> 
        <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;max_length&#39;</span><span class="p">,</span> 
        <span class="n">max_length</span><span class="o">=</span><span class="n">MAX_LENGTH</span><span class="p">,</span> 
        <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
        <span class="n">return_tensors</span><span class="o">=</span><span class="s1">&#39;pt&#39;</span>
    <span class="p">)[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="c1"># get first token of label</span>
    
    <span class="c1"># put label at the last index</span>
    <span class="n">examples</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">examples</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">],</span> <span class="n">IGNORE_INDEX</span><span class="p">)</span>
    <span class="n">examples</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">][:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span>

    <span class="k">return</span> <span class="n">examples</span>

<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">preprocess</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set the wandb project where this run will be logged</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;WANDB_PROJECT&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">TRAIN_DIR</span>

<span class="c1"># save your trained model checkpoint to wandb</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;WANDB_LOG_MODEL&quot;</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;false&quot;</span>

<span class="k">def</span> <span class="nf">accuracy_metric</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">label_ids</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># predictions = x.predictions[0].argmax(axis=-1)[:, -2]  # uncomment for gpt-neox</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">predictions</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_true</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">y_pred</span><span class="o">=</span><span class="n">predictions</span><span class="p">),</span>
    <span class="p">}</span>

<span class="n">train_ds</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">)</span>

<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">8</span>

<span class="n">training_args</span> <span class="o">=</span> <span class="n">TrainingArguments</span><span class="p">(</span>
    <span class="n">output_dir</span><span class="o">=</span><span class="n">TRAIN_DIR</span><span class="p">,</span>
    <span class="n">overwrite_output_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">evaluation_strategy</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-05</span><span class="p">,</span>
    <span class="n">num_train_epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">per_device_train_batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
    <span class="n">per_device_eval_batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
    <span class="n">report_to</span><span class="o">=</span><span class="s2">&quot;wandb&quot;</span><span class="p">,</span> <span class="c1"># optional, remove if you don&#39;t want to log to wandb</span>
    <span class="n">use_cpu</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="n">training_args</span><span class="p">,</span>
    <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_ds</span><span class="p">,</span>
    <span class="n">eval_dataset</span><span class="o">=</span><span class="n">train_ds</span><span class="p">,</span>
    <span class="n">compute_metrics</span><span class="o">=</span><span class="n">accuracy_metric</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Train the model and log it in a Weights &amp; Biases run.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">wandb</span> 

<span class="n">_</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">wandb version 0.16.4 is available!  To upgrade, please run:
 $ pip install wandb --upgrade</div><div class="output text_html">Tracking run with wandb version 0.16.3</div><div class="output text_html">Run data is saved locally in <code>c:\Users\amirz\Source\NLP\clones\pyvene\tutorials\advanced_tutorials\wandb\run-20240314_140315-cwmxs9sx</code></div><div class="output text_html">Syncing run <strong><a href='https://wandb.ai/amirzur1212/mqnli_factual/runs/cwmxs9sx' target="_blank">derby-crumble-2</a></strong> to <a href='https://wandb.ai/amirzur1212/mqnli_factual' target="_blank">Weights & Biases</a> (<a href='https://wandb.me/run' target="_blank">docs</a>)<br/></div><div class="output text_html"> View project at <a href='https://wandb.ai/amirzur1212/mqnli_factual' target="_blank">https://wandb.ai/amirzur1212/mqnli_factual</a></div><div class="output text_html"> View run at <a href='https://wandb.ai/amirzur1212/mqnli_factual/runs/cwmxs9sx' target="_blank">https://wandb.ai/amirzur1212/mqnli_factual/runs/cwmxs9sx</a></div><script type="application/vnd.jupyter.widget-view+json">{"model_id": "5b3008cdd19b4d1f80ef096f3d2c97ef", "version_major": 2, "version_minor": 0}</script><script type="application/vnd.jupyter.widget-view+json">{"model_id": "3fd69497aae04b8c8a7be79b77196a5d", "version_major": 2, "version_minor": 0}</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;eval_loss&#39;: 4.242105484008789, &#39;eval_accuracy&#39;: 0.17, &#39;eval_runtime&#39;: 12.9558, &#39;eval_samples_per_second&#39;: 7.719, &#39;eval_steps_per_second&#39;: 1.003, &#39;epoch&#39;: 1.0}
{&#39;train_runtime&#39;: 52.4216, &#39;train_samples_per_second&#39;: 1.908, &#39;train_steps_per_second&#39;: 0.248, &#39;train_loss&#39;: 5.367249708909255, &#39;epoch&#39;: 1.0}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span><span class="o">.</span><span class="n">save_model</span><span class="p">(</span><span class="n">TRAIN_DIR</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We evaluate the model on the training dataset and a newly-sampled test dataset. The model generalizes, meaning it learned the MQNLI task!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token</span>
<span class="n">test_examples</span> <span class="o">=</span> <span class="n">mqlni_model</span><span class="o">.</span><span class="n">generate_factual_dataset</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">mqlni_model</span><span class="o">.</span><span class="n">sample_input_tree_balanced</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">example</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">test_examples</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">example</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">test_examples</span><span class="p">]</span>
<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">preprocess</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">test_ds</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">train_ds</span><span class="p">)</span>
<span class="n">results</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "f8c92d344b674837bc7733b012829136", "version_major": 2, "version_minor": 0}</script><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;eval_loss&#39;: 4.242105484008789,
 &#39;eval_accuracy&#39;: 0.17,
 &#39;eval_runtime&#39;: 12.6987,
 &#39;eval_samples_per_second&#39;: 7.875,
 &#39;eval_steps_per_second&#39;: 1.024,
 &#39;epoch&#39;: 1.0}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_ds</span><span class="p">)</span>
<span class="n">results</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "ce841fd20aad4b9fa81e502ee8fe8328", "version_major": 2, "version_minor": 0}</script><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;eval_loss&#39;: 4.242105484008789,
 &#39;eval_accuracy&#39;: 0.17,
 &#39;eval_runtime&#39;: 12.532,
 &#39;eval_samples_per_second&#39;: 7.98,
 &#39;eval_steps_per_second&#39;: 1.037,
 &#39;epoch&#39;: 1.0}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wandb</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "bc294f9a84f24cbaa44ceeb6dc1e379c", "version_major": 2, "version_minor": 0}</script><div class="output text_html"><style>
    table.wandb td:nth-child(1) { padding: 0 10px; text-align: left ; width: auto;} td:nth-child(2) {text-align: left ; width: 100%}
    .wandb-row { display: flex; flex-direction: row; flex-wrap: wrap; justify-content: flex-start; width: 100% }
    .wandb-col { display: flex; flex-direction: column; flex-basis: 100%; flex: 1; padding: 10px; }
    </style>
<div class="wandb-row"><div class="wandb-col"><h3>Run history:</h3><br/><table class="wandb"><tr><td>eval/accuracy</td><td>▁▁▁</td></tr><tr><td>eval/loss</td><td>▁▁▁</td></tr><tr><td>eval/runtime</td><td>█▄▁</td></tr><tr><td>eval/samples_per_second</td><td>▁▅█</td></tr><tr><td>eval/steps_per_second</td><td>▁▅█</td></tr><tr><td>train/epoch</td><td>▁▁▁▁</td></tr><tr><td>train/global_step</td><td>▁▁▁▁</td></tr><tr><td>train/total_flos</td><td>▁</td></tr><tr><td>train/train_loss</td><td>▁</td></tr><tr><td>train/train_runtime</td><td>▁</td></tr><tr><td>train/train_samples_per_second</td><td>▁</td></tr><tr><td>train/train_steps_per_second</td><td>▁</td></tr></table><br/></div><div class="wandb-col"><h3>Run summary:</h3><br/><table class="wandb"><tr><td>eval/accuracy</td><td>0.17</td></tr><tr><td>eval/loss</td><td>4.24211</td></tr><tr><td>eval/runtime</td><td>12.532</td></tr><tr><td>eval/samples_per_second</td><td>7.98</td></tr><tr><td>eval/steps_per_second</td><td>1.037</td></tr><tr><td>train/epoch</td><td>1.0</td></tr><tr><td>train/global_step</td><td>13</td></tr><tr><td>train/total_flos</td><td>3266150400000.0</td></tr><tr><td>train/train_loss</td><td>5.36725</td></tr><tr><td>train/train_runtime</td><td>52.4216</td></tr><tr><td>train/train_samples_per_second</td><td>1.908</td></tr><tr><td>train/train_steps_per_second</td><td>0.248</td></tr></table><br/></div></div></div><div class="output text_html"> View run <strong style="color:#cdcd00">derby-crumble-2</strong> at: <a href='https://wandb.ai/amirzur1212/mqnli_factual/runs/cwmxs9sx' target="_blank">https://wandb.ai/amirzur1212/mqnli_factual/runs/cwmxs9sx</a><br/>Synced 5 W&B file(s), 0 media file(s), 0 artifact file(s) and 0 other file(s)</div><div class="output text_html">Find logs at: <code>.\wandb\run-20240314_140315-cwmxs9sx\logs</code></div></div>
</div>
</section>
<section id="interpreting-our-model">
<h2>Interpreting Our Model<a class="headerlink" href="#interpreting-our-model" title="Link to this heading">#</a></h2>
<p>In this final section, we use distributed alignment search DAS from <a class="reference external" href="https://arxiv.org/pdf/2303.02536.pdf">Geiger*, Wu*, Potts, Icard, and Goodman (2024)</a> to find an alignment between the high-level causal structure of MQNLI and our low-level language model trained on the MQNLI dataset.</p>
<p>In this section, we won’t search for an alignment over the entire causal structure. Instead, we will search for an alignment between the low-level model representations and the <code class="docutils literal notranslate"><span class="pre">NegP</span></code> token. Efficiently searching for a full alignment over a complex, nested causal structure is an open problem that is worth pursuing!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">model</span> <span class="o">=</span> <span class="n">create_gpt2_lm</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">TRAIN_DIR</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>loaded model
</pre></div>
</div>
</div>
</div>
<p>Here we set up our alignment. We will search for a subspace with a dimension of 128 (a fourth of our model’s hidden dimension size) in the residual stream of the 10th layer of the model (out of 12 overall transformer layers).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="n">IntervenableConfig</span><span class="p">(</span>
    <span class="n">model_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">),</span>
    <span class="n">representations</span><span class="o">=</span><span class="p">[</span>
        <span class="n">RepresentationConfig</span><span class="p">(</span>
            <span class="mi">10</span><span class="p">,</span>  <span class="c1"># layer</span>
            <span class="s2">&quot;block_output&quot;</span><span class="p">,</span>  <span class="c1"># intervention type</span>
            <span class="s2">&quot;pos&quot;</span><span class="p">,</span>  <span class="c1"># intervention unit is now aligned with tokens</span>
            <span class="mi">1</span><span class="p">,</span>  <span class="c1"># max number of unit</span>
            <span class="n">subspace_partition</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">]],</span> 
            <span class="c1"># intervention_link_key=0,</span>
        <span class="p">)</span>
    <span class="p">],</span>
    <span class="n">intervention_types</span><span class="o">=</span><span class="n">RotatedSpaceIntervention</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">intervenable</span> <span class="o">=</span> <span class="n">IntervenableModel</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">use_fast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># intervenable.set_device(&#39;cuda&#39;)</span>
<span class="n">intervenable</span><span class="o">.</span><span class="n">disable_model_gradients</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:root:Detected use_fast=True means the intervention location will be static within a batch.

In case multiple location tags are passed only the first one will be considered
</pre></div>
</div>
</div>
</div>
<p>Crucially, our interpretability experiments rely on a counterfactual dataset: for a given input, we want to consider what might happen had the value of <code class="docutils literal notranslate"><span class="pre">NegP</span></code> changed while all else remained the same. Fortunately, this is precisely what our causal model can provide us with! We can generate a counterfactual dataset by sampling inputs that only vary from each other on the <code class="docutils literal notranslate"><span class="pre">NegP</span></code> node.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sample_intervention</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;NegP&#39;</span> <span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">mqlni_model</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="s1">&#39;NegP&#39;</span><span class="p">])</span>
    <span class="p">}</span>

<span class="k">def</span> <span class="nf">intervention_id</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">0</span>

<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># specifies how many inputs we want per intervention that is sampled</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">mqlni_model</span><span class="o">.</span><span class="n">generate_counterfactual_dataset</span><span class="p">(</span>
    <span class="mi">100</span><span class="p">,</span> <span class="n">intervention_id</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> 
    <span class="n">sampler</span><span class="o">=</span><span class="n">mqlni_model</span><span class="o">.</span><span class="n">sample_input_tree_balanced</span><span class="p">,</span> <span class="n">intervention_sampler</span><span class="o">=</span><span class="n">sample_intervention</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;base_labels&#39;</span><span class="p">][</span><span class="s1">&#39;QP_S&#39;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="s1">&#39;QP_S&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>alternation
independence
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># check that base labels are diverse (should be guaranteed by sampling from balanced input tree)</span>
<span class="n">Counter</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;base_labels&#39;</span><span class="p">][</span><span class="s1">&#39;QP_S&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Counter({&#39;alternation&#39;: 23,
         &#39;reverse entails&#39;: 10,
         &#39;cover&#39;: 15,
         &#39;equivalence&#39;: 15,
         &#39;contradiction&#39;: 9,
         &#39;independence&#39;: 14,
         &#39;entails&#39;: 14})
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># check that counterfactuals labels are diverse (note that this could be skewed by the node&#39;s effect on the final output)</span>
<span class="n">Counter</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">][</span><span class="s1">&#39;QP_S&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Counter({&#39;independence&#39;: 47,
         &#39;reverse entails&#39;: 10,
         &#39;entails&#39;: 9,
         &#39;alternation&#39;: 20,
         &#39;cover&#39;: 10,
         &#39;contradiction&#39;: 3,
         &#39;equivalence&#39;: 1})
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">IGNORE_INDEX</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span>
<span class="n">MAX_LENGTH</span> <span class="o">=</span> <span class="mi">64</span>

<span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token</span>

<span class="k">def</span> <span class="nf">preprocess_input</span><span class="p">(</span><span class="n">setting</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;Premise: </span><span class="si">{</span><span class="n">premise_to_string</span><span class="p">(</span><span class="n">setting</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">Hypothesis: </span><span class="si">{</span><span class="n">hypothesis_to_string</span><span class="p">(</span><span class="n">setting</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s1">Relation: &#39;</span>

<span class="k">def</span> <span class="nf">preprocess_output</span><span class="p">(</span><span class="n">setting</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">setting</span><span class="p">[</span><span class="s1">&#39;QP_S&#39;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tokenizer</span><span class="p">(</span>
        <span class="n">x</span><span class="p">,</span> 
        <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;max_length&#39;</span><span class="p">,</span> 
        <span class="n">max_length</span><span class="o">=</span><span class="n">MAX_LENGTH</span><span class="p">,</span> 
        <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
        <span class="n">return_tensors</span><span class="o">=</span><span class="s1">&#39;pt&#39;</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">preprocess_counterfactual</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">preprocessed_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">preprocess_input</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">])</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">preprocess_input</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;source_input_ids&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">preprocess_output</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">])</span>
        <span class="n">base_label</span> <span class="o">=</span> <span class="n">preprocess_output</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;base_labels&#39;</span><span class="p">])</span>

        <span class="n">preprocessed</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">preprocessed</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tokenize</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
        <span class="n">preprocessed</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">tokenize</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
        <span class="c1"># place label at last index</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">tokenize</span><span class="p">(</span><span class="n">label</span><span class="p">)[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">preprocessed</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">preprocessed</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">][</span><span class="s1">&#39;input_ids&#39;</span><span class="p">],</span> <span class="n">IGNORE_INDEX</span><span class="p">)</span>
        <span class="n">preprocessed</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">][:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>
        <span class="c1"># repeat for base label</span>
        <span class="n">base_label</span> <span class="o">=</span> <span class="n">tokenize</span><span class="p">(</span><span class="n">base_label</span><span class="p">)[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">preprocessed</span><span class="p">[</span><span class="s1">&#39;base_label&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">preprocessed</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">][</span><span class="s1">&#39;input_ids&#39;</span><span class="p">],</span> <span class="n">IGNORE_INDEX</span><span class="p">)</span>
        <span class="n">preprocessed</span><span class="p">[</span><span class="s1">&#39;base_label&#39;</span><span class="p">][:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_label</span>
        <span class="n">preprocessed</span><span class="p">[</span><span class="s1">&#39;intervention_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;intervention_id&#39;</span><span class="p">])</span>
        <span class="n">preprocessed_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">preprocessed</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">preprocessed_data</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">preprocess_counterfactual</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Set up our optimizer, loss function, and accuracy metric.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">gradient_accumulation_steps</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">optimizer_params</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">intervenable</span><span class="o">.</span><span class="n">interventions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">optimizer_params</span> <span class="o">+=</span> <span class="p">[{</span><span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">rotate_layer</span><span class="o">.</span><span class="n">parameters</span><span class="p">()}]</span>
    <span class="k">break</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">optimizer_params</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">compute_metrics</span><span class="p">(</span><span class="n">eval_preds</span><span class="p">,</span> <span class="n">eval_labels</span><span class="p">):</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span>
        <span class="n">y_pred</span><span class="o">=</span><span class="n">eval_preds</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> 
        <span class="n">y_true</span><span class="o">=</span><span class="n">eval_labels</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;accuracy&quot;</span><span class="p">:</span> <span class="n">accuracy</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">compute_loss</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
    <span class="c1"># Shift so that tokens &lt; n predict n</span>
    <span class="n">shift_logits</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
    <span class="n">shift_labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
    <span class="c1"># Flatten the tokens</span>
    <span class="n">loss_fct</span> <span class="o">=</span> <span class="n">CrossEntropyLoss</span><span class="p">()</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">loss_fct</span><span class="p">(</span><span class="n">shift_logits</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">shift_logits</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="n">shift_labels</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">loss</span>
</pre></div>
</div>
</div>
</div>
<p>Run DAS to find an alignment between our high-level causal model and the language model trained on MQNLI.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">intervenable</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>  <span class="c1"># train enables drop-off but no grads</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;intervention trainable parameters: &quot;</span><span class="p">,</span> <span class="n">intervenable</span><span class="o">.</span><span class="n">count_parameters</span><span class="p">())</span>
<span class="n">train_iterator</span> <span class="o">=</span> <span class="n">trange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">epochs</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Epoch&quot;</span><span class="p">)</span>

<span class="n">total_step</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">train_iterator</span><span class="p">:</span>
    <span class="n">epoch_iterator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
        <span class="n">DataLoader</span><span class="p">(</span>
            <span class="n">train_dataset</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
            <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">),</span>
        <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">position</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">leave</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">epoch_iterator</span><span class="p">:</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">intervenable</span><span class="o">.</span><span class="n">get_device</span><span class="p">())</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="p">[{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">intervenable</span><span class="o">.</span><span class="n">get_device</span><span class="p">())</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">counterfactual_outputs</span> <span class="o">=</span> <span class="n">intervenable</span><span class="p">(</span>
            <span class="n">inputs</span><span class="p">,</span>
            <span class="n">sources</span><span class="p">,</span>
            <span class="p">{</span><span class="s2">&quot;sources-&gt;base&quot;</span><span class="p">:</span> <span class="p">([[[</span><span class="n">MAX_LENGTH</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">],</span> <span class="p">[[[</span><span class="n">MAX_LENGTH</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">])},</span>
            <span class="n">subspaces</span><span class="o">=</span><span class="p">[[[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="n">eval_metrics</span> <span class="o">=</span> <span class="n">compute_metrics</span><span class="p">(</span>
            <span class="n">counterfactual_outputs</span><span class="o">.</span><span class="n">logits</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">intervenable</span><span class="o">.</span><span class="n">get_device</span><span class="p">())</span>
        <span class="p">)</span>

        <span class="c1"># loss and backprop</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">compute_loss</span><span class="p">(</span>
            <span class="n">counterfactual_outputs</span><span class="o">.</span><span class="n">logits</span><span class="p">,</span> <span class="n">batch</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">intervenable</span><span class="o">.</span><span class="n">get_device</span><span class="p">())</span>
        <span class="p">)</span>

        <span class="n">epoch_iterator</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">({</span><span class="s2">&quot;loss&quot;</span><span class="p">:</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="s2">&quot;acc&quot;</span><span class="p">:</span> <span class="n">eval_metrics</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">]})</span>

        <span class="k">if</span> <span class="n">gradient_accumulation_steps</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">loss</span> <span class="o">/</span> <span class="n">gradient_accumulation_steps</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">total_step</span> <span class="o">%</span> <span class="n">gradient_accumulation_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
            <span class="n">intervenable</span><span class="o">.</span><span class="n">set_zero_grad</span><span class="p">()</span>
        <span class="n">total_step</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>intervention trainable parameters:  589824
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch: 0: 100%|██████████| 12/12 [00:59&lt;00:00,  4.93s/it, loss=6.88, acc=0]    

Epoch: 1: 100%|██████████| 12/12 [00:58&lt;00:00,  4.91s/it, loss=5.86, acc=0]   

Epoch: 2: 100%|██████████| 12/12 [00:59&lt;00:00,  4.98s/it, loss=6.37, acc=0]    

Epoch: 100%|██████████| 3/3 [02:57&lt;00:00, 59.28s/it]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">intervenable</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">DAS_DIR</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Directory &#39;mqnli_das&#39; already exists.
</pre></div>
</div>
</div>
</div>
<section id="evaluate-das-alignment">
<h3>Evaluate DAS Alignment<a class="headerlink" href="#evaluate-das-alignment" title="Link to this heading">#</a></h3>
<p>Lastly, we evaluate the accuracy of the alignment found by DAS.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">model</span> <span class="o">=</span> <span class="n">create_gpt2_lm</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">TRAIN_DIR</span><span class="p">)</span>
<span class="n">intervenable</span> <span class="o">=</span> <span class="n">IntervenableModel</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">DAS_DIR</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:root:The key is provided in the config. Assuming this is loaded from a pretrained module.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>loaded model
</pre></div>
</div>
</div>
</div>
<p>First, we evaluate the model’s performance on the MQNLI factual task. As before, we expect our model to complete this task with nearly perfect accuracy.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token</span>
<span class="n">examples</span> <span class="o">=</span> <span class="n">mqlni_model</span><span class="o">.</span><span class="n">generate_factual_dataset</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">sampler</span><span class="o">=</span><span class="n">mqlni_model</span><span class="o">.</span><span class="n">sample_input_tree_balanced</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">example</span><span class="p">[</span><span class="s1">&#39;input_ids&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">example</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">]</span>
<span class="n">test_factual_dataset</span> <span class="o">=</span> <span class="n">preprocess</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">accuracy_metric</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">label_ids</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># predictions = x.predictions[0].argmax(axis=-1)[:, -2]  # take one index before label</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">predictions</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y_true</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">y_pred</span><span class="o">=</span><span class="n">predictions</span><span class="p">),</span>
    <span class="p">}</span>

<span class="n">test_factual_ds</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">test_factual_dataset</span><span class="p">)</span>

<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">8</span>

<span class="n">training_args</span> <span class="o">=</span> <span class="n">TrainingArguments</span><span class="p">(</span>
    <span class="n">output_dir</span><span class="o">=</span><span class="s2">&quot;test_mqnli_trainer&quot;</span><span class="p">,</span>
    <span class="n">overwrite_output_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">evaluation_strategy</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">1e-05</span><span class="p">,</span>
    <span class="n">num_train_epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">per_device_train_batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
    <span class="n">per_device_eval_batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
    <span class="n">report_to</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
    <span class="n">use_cpu</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="n">intervenable</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="n">training_args</span><span class="p">,</span>
    <span class="n">compute_metrics</span><span class="o">=</span><span class="n">accuracy_metric</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trainer</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_factual_ds</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "ba33bc2aaff448c1bd8ef2e97ed4f74b", "version_major": 2, "version_minor": 0}</script><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;eval_loss&#39;: 4.302060127258301,
 &#39;eval_accuracy&#39;: 0.17,
 &#39;eval_runtime&#39;: 18.8671,
 &#39;eval_samples_per_second&#39;: 5.3,
 &#39;eval_steps_per_second&#39;: 0.689}
</pre></div>
</div>
</div>
</div>
<p>Next, we evaluate the DAS alignment on a newly-sampled counterfactual dataset. If our alignment generalizes, then we should expect a high interchange intervention accuracy (IIA) on the counterfactual dataset. We compute IIA by comparing the model’s output with an interchange-intervention to the causal model’s output with that same intervention applied to its high-level variables (i.e., we verify that an intervention changes the model’s output in the direction that our causal model predicts).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">8</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">mqlni_model</span><span class="o">.</span><span class="n">generate_counterfactual_dataset</span><span class="p">(</span>
    <span class="mi">1000</span><span class="p">,</span> <span class="n">intervention_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> 
    <span class="n">sampler</span><span class="o">=</span><span class="n">mqlni_model</span><span class="o">.</span><span class="n">sample_input_tree_balanced</span><span class="p">,</span> <span class="n">intervention_sampler</span><span class="o">=</span><span class="n">sample_intervention</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_cf_dataset</span> <span class="o">=</span> <span class="n">preprocess_counterfactual</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">compute_metrics</span><span class="p">(</span><span class="n">eval_preds</span><span class="p">,</span> <span class="n">eval_labels</span><span class="p">):</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span>
        <span class="n">y_pred</span><span class="o">=</span><span class="n">eval_preds</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> 
        <span class="n">y_true</span><span class="o">=</span><span class="n">eval_labels</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;accuracy&quot;</span><span class="p">:</span> <span class="n">accuracy</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">intervenable</span><span class="o">.</span><span class="n">set_device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>
<span class="c1"># intervenable.disable_intervention_gradients()</span>
<span class="c1"># intervenable.disable_model_gradients()</span>
<span class="c1"># intervenable.model.eval()  # train enables drop-off but no grads</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;intervention trainable parameters: &quot;</span><span class="p">,</span> <span class="n">intervenable</span><span class="o">.</span><span class="n">count_parameters</span><span class="p">())</span>

<span class="n">base_labels</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">counterfactual_labels</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">base_preds</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">counterfactual_preds</span> <span class="o">=</span> <span class="kc">None</span>

<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">8</span>

<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">DataLoader</span><span class="p">(</span>
        <span class="n">test_cf_dataset</span><span class="p">,</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">drop_last</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)):</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">intervenable</span><span class="o">.</span><span class="n">get_device</span><span class="p">())</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="p">[{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">intervenable</span><span class="o">.</span><span class="n">get_device</span><span class="p">())</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">counterfactual_outputs</span> <span class="o">=</span> <span class="n">intervenable</span><span class="p">(</span>
            <span class="n">inputs</span><span class="p">,</span>
            <span class="n">sources</span><span class="p">,</span>
            <span class="p">{</span><span class="s2">&quot;sources-&gt;base&quot;</span><span class="p">:</span> <span class="p">([[[</span><span class="n">MAX_LENGTH</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">],</span> <span class="p">[[[</span><span class="n">MAX_LENGTH</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">])},</span>
            <span class="n">subspaces</span><span class="o">=</span><span class="p">[[[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">base_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># base_preds = base_outputs.logits.argmax(-1).clone().detach()</span>
            <span class="c1"># base_labels = batch[&#39;base_label&#39;]</span>
            <span class="n">counterfactual_preds</span> <span class="o">=</span> <span class="n">counterfactual_outputs</span><span class="o">.</span><span class="n">logits</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
            <span class="n">counterfactual_labels</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># base_preds = torch.cat((base_preds, base_outputs.logits.argmax(-1).clone().detach()))</span>
            <span class="c1"># base_labels = torch.cat((base_labels, batch[&#39;base_label&#39;]))</span>
            <span class="n">counterfactual_preds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">counterfactual_preds</span><span class="p">,</span> <span class="n">counterfactual_outputs</span><span class="o">.</span><span class="n">logits</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()))</span>
            <span class="n">counterfactual_labels</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">counterfactual_labels</span><span class="p">,</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="c1"># &#39;base_accuracy&#39;: compute_metrics(base_preds, base_labels)[&#39;accuracy&#39;],</span>
    <span class="s1">&#39;counterfactual_accuracy&#39;</span><span class="p">:</span> <span class="n">compute_metrics</span><span class="p">(</span><span class="n">counterfactual_preds</span><span class="p">,</span> <span class="n">counterfactual_labels</span><span class="p">)[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;counterfactual_accuracy&#39;: 0.125}
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="Interventions_with_BLIP.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Intervening on Vision-Language Models</p>
      </div>
    </a>
    <a class="right-next"
       href="Voting_Mechanism.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">An Exploration on Voting Mechanisms</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up">Set-Up</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-mqnli-task">The MQNLI Task</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example-mqnli-input">Example MQNLI Input</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mqnli-with-an-intervention">MQNLI with an Intervention</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#training-a-model-on-mqnli">Training a Model on MQNLI</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interpreting-our-model">Interpreting Our Model</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluate-das-alignment">Evaluate DAS Alignment</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Stanford NLP
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024, Stanford NLP.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>