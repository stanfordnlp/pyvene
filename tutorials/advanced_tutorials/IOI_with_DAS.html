
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>IOI with DAS &#8212; pyvene 0.1.2 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=0deb7d70"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'tutorials/advanced_tutorials/IOI_with_DAS';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="IOI with Masked Interventions" href="IOI_with_Mask_Intervention.html" />
    <link rel="prev" title="Replicating the IOI paper" href="IOI_Replication.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">pyvene 0.1.2 documentation</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Guides</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../guides/contributing.html">Contributing Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/causal_abstraction.html">A Little Guide to Causal Abstraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guides/ndif.html">NDIF Integration</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Basic tutorials</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../pyvene_101.html">Introduction to pyvene</a></li>

<li class="toctree-l1"><a class="reference internal" href="../basic_tutorials/Add_Activations_to_Streams.html">Activation Addition</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basic_tutorials/Basic_Intervention.html">Interchange Intervention</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basic_tutorials/Nested_Intervention.html">Intervening on subcomponents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basic_tutorials/Subspace_Partition_with_Intervention.html">Subspace Interventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basic_tutorials/Intervention_Training.html">Trainable Interventions</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Advanced tutorials</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Causal_Tracing.html">Causal Tracing (ROME)</a></li>

<li class="toctree-l1"><a class="reference internal" href="Probing_Gender.html">Causal Evaluation of Probes</a></li>
<li class="toctree-l1"><a class="reference internal" href="DAS_Main_Introduction.html">Intro to Distributed Alignment Search (DAS)</a></li>




<li class="toctree-l1"><a class="reference internal" href="Boundless_DAS.html">Boundless DAS</a></li>
<li class="toctree-l1"><a class="reference internal" href="IOI_Replication.html">Replicating the IOI paper</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">IOI with DAS</a></li>
<li class="toctree-l1"><a class="reference internal" href="IOI_with_Mask_Intervention.html">IOI with Masked Interventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="Interventions_with_BLIP.html">Intervening on Vision-Language Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="MQNLI.html">Nested Hierarchical Structure with MQNLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="Voting_Mechanism.html">An Exploration on Voting Mechanisms</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">API</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../../api/core.html"><code class="docutils literal notranslate"><span class="pre">pyvene</span></code>: Core API</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/pyvene.data_generators.html">pyvene.data_generators</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.data_generators.causal_model.html">pyvene.data_generators.causal_model</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.data_generators.causal_model.simple_example.html">pyvene.data_generators.causal_model.simple_example</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.data_generators.causal_model.CausalModel.html">pyvene.data_generators.causal_model.CausalModel</a></li>
</ul>
</details></li>
</ul>
</details></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api/pyvene.models.html">pyvene.models</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.backpack_gpt2.html">pyvene.models.backpack_gpt2</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.backpack_gpt2.modelings_backpack_gpt2.html">pyvene.models.backpack_gpt2.modelings_backpack_gpt2</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.backpack_gpt2.modelings_intervenable_backpack_gpt2.html">pyvene.models.backpack_gpt2.modelings_intervenable_backpack_gpt2</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.basic_utils.html">pyvene.models.basic_utils</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.basic_utils.GET_LOC.html">pyvene.models.basic_utils.GET_LOC</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.basic_utils.closeness_to_permutation_loss.html">pyvene.models.basic_utils.closeness_to_permutation_loss</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.basic_utils.count_parameters.html">pyvene.models.basic_utils.count_parameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.basic_utils.create_directory.html">pyvene.models.basic_utils.create_directory</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.basic_utils.embed_to_distrib.html">pyvene.models.basic_utils.embed_to_distrib</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.basic_utils.format_token.html">pyvene.models.basic_utils.format_token</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.basic_utils.get_batch_size.html">pyvene.models.basic_utils.get_batch_size</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.basic_utils.get_list_depth.html">pyvene.models.basic_utils.get_list_depth</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.basic_utils.get_type_from_string.html">pyvene.models.basic_utils.get_type_from_string</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.basic_utils.harmonic_sigmoid_boundary.html">pyvene.models.basic_utils.harmonic_sigmoid_boundary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.basic_utils.random_permutation_matrix.html">pyvene.models.basic_utils.random_permutation_matrix</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.basic_utils.set_seed.html">pyvene.models.basic_utils.set_seed</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.basic_utils.sigmoid_boundary.html">pyvene.models.basic_utils.sigmoid_boundary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.basic_utils.top_vals.html">pyvene.models.basic_utils.top_vals</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.blip.html">pyvene.models.blip</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.blip.modelings_blip.html">pyvene.models.blip.modelings_blip</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.blip.modelings_blip_itm.html">pyvene.models.blip.modelings_blip_itm</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.blip.modelings_intervenable_blip.html">pyvene.models.blip.modelings_intervenable_blip</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.blip.modelings_intervenable_blip_itm.html">pyvene.models.blip.modelings_intervenable_blip_itm</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.configuration_intervenable_model.html">pyvene.models.configuration_intervenable_model</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.configuration_intervenable_model.IntervenableConfig.html">pyvene.models.configuration_intervenable_model.IntervenableConfig</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.configuration_intervenable_model.RepresentationConfig.html">pyvene.models.configuration_intervenable_model.RepresentationConfig</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.constants.html">pyvene.models.constants</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.constants.split_and_select.html">pyvene.models.constants.split_and_select</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.constants.split_half.html">pyvene.models.constants.split_half</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.constants.split_head_and_permute.html">pyvene.models.constants.split_head_and_permute</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.constants.split_heads.html">pyvene.models.constants.split_heads</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.constants.split_three.html">pyvene.models.constants.split_three</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.esm.html">pyvene.models.esm</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.esm.modelings_intervenable_esm.html">pyvene.models.esm.modelings_intervenable_esm</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.gemma.html">pyvene.models.gemma</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.gemma.modelings_intervenable_gemma.html">pyvene.models.gemma.modelings_intervenable_gemma</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.gemma2.html">pyvene.models.gemma2</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.gemma2.modelings_intervenable_gemma2.html">pyvene.models.gemma2.modelings_intervenable_gemma2</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.gpt2.html">pyvene.models.gpt2</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.gpt2.modelings_intervenable_gpt2.html">pyvene.models.gpt2.modelings_intervenable_gpt2</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.gpt_neo.html">pyvene.models.gpt_neo</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.gpt_neo.modelings_intervenable_gpt_neo.html">pyvene.models.gpt_neo.modelings_intervenable_gpt_neo</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.gpt_neox.html">pyvene.models.gpt_neox</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.gpt_neox.modelings_intervenable_gpt_neox.html">pyvene.models.gpt_neox.modelings_intervenable_gpt_neox</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.gpt_oss.html">pyvene.models.gpt_oss</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.gpt_oss.modelings_intervenable_gpt_oss.html">pyvene.models.gpt_oss.modelings_intervenable_gpt_oss</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.gru.html">pyvene.models.gru</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.gru.modelings_gru.html">pyvene.models.gru.modelings_gru</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.gru.modelings_intervenable_gru.html">pyvene.models.gru.modelings_intervenable_gru</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.intervenable_base.html">pyvene.models.intervenable_base</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.intervenable_base.build_intervenable_model.html">pyvene.models.intervenable_base.build_intervenable_model</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.intervenable_base.BaseModel.html">pyvene.models.intervenable_base.BaseModel</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.intervenable_base.IntervenableModel.html">pyvene.models.intervenable_base.IntervenableModel</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.intervenable_base.IntervenableModelOutput.html">pyvene.models.intervenable_base.IntervenableModelOutput</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.intervenable_base.IntervenableNdifModel.html">pyvene.models.intervenable_base.IntervenableNdifModel</a></li>
</ul>
</details></li>
<li class="toctree-l3"><a class="reference internal" href="../../api/pyvene.models.intervenable_modelcard.html">pyvene.models.intervenable_modelcard</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.intervention_utils.html">pyvene.models.intervention_utils</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.intervention_utils.broadcast_tensor_v1.html">pyvene.models.intervention_utils.broadcast_tensor_v1</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.intervention_utils.broadcast_tensor_v2.html">pyvene.models.intervention_utils.broadcast_tensor_v2</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.intervention_utils.InterventionState.html">pyvene.models.intervention_utils.InterventionState</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.interventions.html">pyvene.models.interventions</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.AdditionIntervention.html">pyvene.models.interventions.AdditionIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.AutoencoderIntervention.html">pyvene.models.interventions.AutoencoderIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.BasisAgnosticIntervention.html">pyvene.models.interventions.BasisAgnosticIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.BoundlessRotatedSpaceIntervention.html">pyvene.models.interventions.BoundlessRotatedSpaceIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.CollectIntervention.html">pyvene.models.interventions.CollectIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.ConstantSourceIntervention.html">pyvene.models.interventions.ConstantSourceIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.DistributedRepresentationIntervention.html">pyvene.models.interventions.DistributedRepresentationIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.Intervention.html">pyvene.models.interventions.Intervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.InterventionOutput.html">pyvene.models.interventions.InterventionOutput</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.JumpReLUAutoencoderIntervention.html">pyvene.models.interventions.JumpReLUAutoencoderIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.LocalistRepresentationIntervention.html">pyvene.models.interventions.LocalistRepresentationIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.LowRankRotatedSpaceIntervention.html">pyvene.models.interventions.LowRankRotatedSpaceIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.NoiseIntervention.html">pyvene.models.interventions.NoiseIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.PCARotatedSpaceIntervention.html">pyvene.models.interventions.PCARotatedSpaceIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.RotatedSpaceIntervention.html">pyvene.models.interventions.RotatedSpaceIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.SharedWeightsTrainableIntervention.html">pyvene.models.interventions.SharedWeightsTrainableIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.SigmoidMaskIntervention.html">pyvene.models.interventions.SigmoidMaskIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.SigmoidMaskRotatedSpaceIntervention.html">pyvene.models.interventions.SigmoidMaskRotatedSpaceIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.SkipIntervention.html">pyvene.models.interventions.SkipIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.SourcelessIntervention.html">pyvene.models.interventions.SourcelessIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.SubtractionIntervention.html">pyvene.models.interventions.SubtractionIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.TrainableIntervention.html">pyvene.models.interventions.TrainableIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.VanillaIntervention.html">pyvene.models.interventions.VanillaIntervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.interventions.ZeroIntervention.html">pyvene.models.interventions.ZeroIntervention</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.layers.html">pyvene.models.layers</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.layers.AutoencoderLayer.html">pyvene.models.layers.AutoencoderLayer</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.layers.AutoencoderLayerBase.html">pyvene.models.layers.AutoencoderLayerBase</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.layers.InverseRotateLayer.html">pyvene.models.layers.InverseRotateLayer</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.layers.LowRankRotateLayer.html">pyvene.models.layers.LowRankRotateLayer</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.layers.RotateLayer.html">pyvene.models.layers.RotateLayer</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.layers.SubspaceLowRankRotateLayer.html">pyvene.models.layers.SubspaceLowRankRotateLayer</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.llama.html">pyvene.models.llama</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.llama.modelings_intervenable_llama.html">pyvene.models.llama.modelings_intervenable_llama</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.llava.html">pyvene.models.llava</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.llava.modelings_intervenable_llava.html">pyvene.models.llava.modelings_intervenable_llava</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.mistral.html">pyvene.models.mistral</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.mistral.modellings_intervenable_mistral.html">pyvene.models.mistral.modellings_intervenable_mistral</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.mllama.html">pyvene.models.mllama</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.mllama.modelings_intervenable_mllama.html">pyvene.models.mllama.modelings_intervenable_mllama</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.mlp.html">pyvene.models.mlp</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.mlp.modelings_intervenable_mlp.html">pyvene.models.mlp.modelings_intervenable_mlp</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.mlp.modelings_mlp.html">pyvene.models.mlp.modelings_mlp</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.html">pyvene.models.modeling_utils</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.b_sd_to_bsd.html">pyvene.models.modeling_utils.b_sd_to_bsd</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.bhsd_to_bs_hd.html">pyvene.models.modeling_utils.bhsd_to_bs_hd</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.bs_hd_to_bhsd.html">pyvene.models.modeling_utils.bs_hd_to_bhsd</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.bsd_to_b_sd.html">pyvene.models.modeling_utils.bsd_to_b_sd</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.do_intervention.html">pyvene.models.modeling_utils.do_intervention</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.gather_neurons.html">pyvene.models.modeling_utils.gather_neurons</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.get_dimension_by_component.html">pyvene.models.modeling_utils.get_dimension_by_component</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.get_internal_model_type.html">pyvene.models.modeling_utils.get_internal_model_type</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.get_module_hook.html">pyvene.models.modeling_utils.get_module_hook</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.getattr_for_torch_module.html">pyvene.models.modeling_utils.getattr_for_torch_module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.is_gru.html">pyvene.models.modeling_utils.is_gru</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.is_mlp.html">pyvene.models.modeling_utils.is_mlp</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.is_stateless.html">pyvene.models.modeling_utils.is_stateless</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.is_transformer.html">pyvene.models.modeling_utils.is_transformer</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.output_to_subcomponent.html">pyvene.models.modeling_utils.output_to_subcomponent</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.print_forward_hooks.html">pyvene.models.modeling_utils.print_forward_hooks</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.remove_forward_hooks.html">pyvene.models.modeling_utils.remove_forward_hooks</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.scatter_neurons.html">pyvene.models.modeling_utils.scatter_neurons</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.simple_output_to_subcomponent.html">pyvene.models.modeling_utils.simple_output_to_subcomponent</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.simple_scatter_intervention_output.html">pyvene.models.modeling_utils.simple_scatter_intervention_output</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.weighted_average.html">pyvene.models.modeling_utils.weighted_average</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.HandlerList.html">pyvene.models.modeling_utils.HandlerList</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.modeling_utils.LambdaIntervention.html">pyvene.models.modeling_utils.LambdaIntervention</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.olmo.html">pyvene.models.olmo</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.olmo.modelings_intervenable_olmo.html">pyvene.models.olmo.modelings_intervenable_olmo</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.olmo2.html">pyvene.models.olmo2</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.olmo2.modelings_intervenable_olmo2.html">pyvene.models.olmo2.modelings_intervenable_olmo2</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.qwen2.html">pyvene.models.qwen2</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.qwen2.modelings_intervenable_qwen2.html">pyvene.models.qwen2.modelings_intervenable_qwen2</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api/pyvene.models.qwen3.html">pyvene.models.qwen3</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api/pyvene.models.qwen3.modelings_intervenable_qwen3.html">pyvene.models.qwen3.modelings_intervenable_qwen3</a></li>
</ul>
</details></li>
</ul>
</details></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/tutorials/advanced_tutorials/IOI_with_DAS.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>IOI with DAS</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up">Set-up</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#factual-recall">Factual recall</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#localizing-the-name-position-information-in-the-main-residual-stream-and-mlp-activations">Localizing the name position information in the main residual stream and MLP activations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#localizing-in-across-multiple-tokens-at-layer-7-one-layer-earlier-than-layer-8">Localizing in across multiple tokens at layer 7, one layer earlier than layer 8</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#localizing-in-different-streams">Localizing in different streams</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#localizing-in-each-individual-head-at-layer-7-and-8">Localizing in each individual head at layer 7 and 8</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#localizing-with-group-of-heads-using-rankings-of-missing-out-head-iia">Localizing with group of heads using rankings of missing out head IIA</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#localizing-the-correct-io-name-with-vanilla-causal-abstraction-no-training">Localizing the correct IO name with vanilla causal abstraction (no training)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#localizing-the-correct-io-name-with-das-20-names-only-with-20-dimension-das">Localizing the correct IO name with DAS (20 names only with 20 dimension DAS)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#head-s-query-representations-to-trace-name-mover-head">Head’s Query Representations to Trace Name Mover Head</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-boundless-das-to-find-information">Use Boundless DAS to find information</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#das-and-boundless-das-weight-matrix-and-head-importance">DAS and Boundless DAS weight matrix and head importance</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="ioi-with-das">
<h1>IOI with DAS<a class="headerlink" href="#ioi-with-das" title="Link to this heading">#</a></h1>
<p><a class="reference external" href="https://colab.research.google.com/github/frankaging/pyvene/blob/main/tutorials/Indirect%20object%20identification%20(IOI)%20circuit%20with%20DAS.ipynb"><img alt="Open In Colab" src="https://colab.research.google.com/assets/colab-badge.svg" /></a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Zhengxuan Wu&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;12/31/2023&quot;</span>
</pre></div>
</div>
</div>
</div>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">#</a></h2>
<p>This tutorial aims to replicate key findings from previous mechanistic interpretability papers that examine the IOI task using this library. It focuses on identifying alignments for the name position information and the output IO name at various locations within the neural networks.</p>
<p>Additionally, the tutorial seeks to provide new insights into GPT-2’s causal mechanisms in solving this task by analyzing how information is stored and processed across different attention heads.</p>
</section>
<section id="set-up">
<h2>Set-up<a class="headerlink" href="#set-up" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="c1"># This library is our indicator that the required installs</span>
    <span class="c1"># need to be done.</span>
    <span class="kn">import</span> <span class="nn">pyvene</span>

<span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
    <span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>git+https://github.com/stanfordnlp/pyvene.git
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">tutorial_ioi_utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pyvene</span> <span class="kn">import</span> <span class="n">embed_to_distrib</span><span class="p">,</span> <span class="n">top_vals</span><span class="p">,</span> <span class="n">format_token</span><span class="p">,</span> <span class="n">sigmoid_boundary</span>
<span class="kn">from</span> <span class="nn">pyvene</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">IntervenableModel</span><span class="p">,</span>
    <span class="n">RepresentationConfig</span><span class="p">,</span>
    <span class="n">IntervenableConfig</span><span class="p">,</span>
    <span class="n">LowRankRotatedSpaceIntervention</span><span class="p">,</span>
    <span class="n">SkipIntervention</span><span class="p">,</span>
    <span class="n">VanillaIntervention</span><span class="p">,</span>
    <span class="n">BoundlessRotatedSpaceIntervention</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pyvene</span> <span class="kn">import</span> <span class="n">create_gpt2_lm</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="o">%</span><span class="k">config</span> InlineBackend.figure_formats = [&#39;svg&#39;]
<span class="kn">from</span> <span class="nn">plotnine</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">,</span>
    <span class="n">geom_tile</span><span class="p">,</span>
    <span class="n">aes</span><span class="p">,</span>
    <span class="n">facet_wrap</span><span class="p">,</span>
    <span class="n">theme</span><span class="p">,</span>
    <span class="n">element_text</span><span class="p">,</span>
    <span class="n">geom_bar</span><span class="p">,</span>
    <span class="n">geom_hline</span><span class="p">,</span>
    <span class="n">scale_y_log10</span><span class="p">,</span>
    <span class="n">scale_y_reverse</span><span class="p">,</span>
    <span class="n">scale_fill_cmap</span><span class="p">,</span>
    <span class="n">geom_text</span><span class="p">,</span>
    <span class="n">scale_fill_gradient</span><span class="p">,</span>
    <span class="n">geom_point</span><span class="p">,</span>
    <span class="n">geom_line</span><span class="p">,</span>
    <span class="n">theme_minimal</span><span class="p">,</span>
    <span class="n">ylim</span><span class="p">,</span>
    <span class="n">ggtitle</span><span class="p">,</span>
    <span class="n">ggsave</span><span class="p">,</span>
    <span class="n">labs</span><span class="p">,</span>
    <span class="n">scale_x_discrete</span><span class="p">,</span>
    <span class="n">geom_histogram</span><span class="p">,</span>
    <span class="n">scale_fill_manual</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># please try not to do this, the plot somehow throw warnings though :(</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="n">config</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">gpt2</span> <span class="o">=</span> <span class="n">create_gpt2_lm</span><span class="p">()</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">gpt2</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>loaded model
</pre></div>
</div>
</div>
</div>
</section>
<section id="factual-recall">
<h2>Factual recall<a class="headerlink" href="#factual-recall" title="Link to this heading">#</a></h2>
<p>We first check IOI task performance of GPT-2.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">transformers</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">eos_token</span>

<span class="k">def</span> <span class="nf">get_last_token</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">attention_mask</span><span class="p">):</span>
    <span class="n">last_token_indices</span> <span class="o">=</span> <span class="n">attention_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">batch_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">logits</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">logits</span><span class="p">[</span><span class="n">batch_indices</span><span class="p">,</span> <span class="n">last_token_indices</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="n">train_distribution</span> <span class="o">=</span> <span class="n">PromptDistribution</span><span class="p">(</span>
    <span class="n">names</span><span class="o">=</span><span class="n">NAMES</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">NAMES</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">],</span>
    <span class="n">objects</span><span class="o">=</span><span class="n">OBJECTS</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">OBJECTS</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">],</span>
    <span class="n">places</span><span class="o">=</span><span class="n">PLACES</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">PLACES</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">],</span>
    <span class="n">templates</span><span class="o">=</span><span class="n">TEMPLATES_PATH</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">D_train</span> <span class="o">=</span> <span class="n">train_distribution</span><span class="o">.</span><span class="n">sample_das</span><span class="p">(</span>
    <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
    <span class="n">base_patterns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ABB&quot;</span><span class="p">,</span> <span class="s2">&quot;BAB&quot;</span><span class="p">],</span>
    <span class="n">source_patterns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ABB&quot;</span><span class="p">,</span> <span class="s2">&quot;BAB&quot;</span><span class="p">],</span>
    <span class="n">labels</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">,</span>
    <span class="n">samples_per_combination</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">total_count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">correct_count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">batch_dataset</span> <span class="ow">in</span> <span class="n">D_train</span><span class="o">.</span><span class="n">batches</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">batch_dataset</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">tokens</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
                <span class="n">inputs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">gpt2</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">batch_dataset</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">answer_tokens</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">gpt2</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

        <span class="n">outputs</span> <span class="o">=</span> <span class="n">gpt2</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="n">get_last_token</span><span class="p">(</span><span class="n">outputs</span><span class="o">.</span><span class="n">logits</span><span class="p">,</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">pred_labels</span> <span class="o">=</span> <span class="n">logits</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">correct_labels</span> <span class="o">=</span> <span class="n">labels</span> <span class="o">==</span> <span class="n">pred_labels</span>

        <span class="n">total_count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">correct_labels</span><span class="p">)</span>
        <span class="n">correct_count</span> <span class="o">+=</span> <span class="n">correct_labels</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">current_acc</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">correct_count</span> <span class="o">/</span> <span class="n">total_count</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;gpt-2 IOI task accuracy: </span><span class="si">{</span><span class="n">current_acc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>gpt-2 IOI task accuracy: 0.91
</pre></div>
</div>
</div>
</div>
</section>
<section id="localizing-the-name-position-information-in-the-main-residual-stream-and-mlp-activations">
<h2>Localizing the name position information in the main residual stream and MLP activations<a class="headerlink" href="#localizing-the-name-position-information-in-the-main-residual-stream-and-mlp-activations" title="Link to this heading">#</a></h2>
<p>This section reproduces main results in <a class="reference external" href="https://arxiv.org/pdf/2311.17030.pdf">this paper</a>. To address the IOI task, previous studies have shown that GPT-2 creates representations for a causal variable representing the correct name position (either the first or second name mentioned in a sentence). Our objective is to utilize our library to pinpoint the location of name position information at each layer and across several positions, not just at the last token position.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">block_out_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="n">positions</span><span class="o">=</span><span class="p">[</span><span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">],</span>
    <span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="n">stream</span><span class="o">=</span><span class="s2">&quot;block_output&quot;</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>finding name position at: pos-&gt;13, layers-&gt;0, stream-&gt;block_output
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">AssertionError</span><span class="g g-Whitespace">                            </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">block_out_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="n">gpt2</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="n">tokenizer</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="n">positions</span><span class="o">=</span><span class="p">[</span><span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">],</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="n">stream</span><span class="o">=</span><span class="s2">&quot;block_output&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>     <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>     <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span> <span class="p">)</span>

<span class="nn">File ~/Documents/Code/pyvene/tutorials/advanced_tutorials/tutorial_ioi_utils.py:704,</span> in <span class="ni">find_variable_at</span><span class="nt">(gpt2, tokenizer, positions, layers, stream, heads, low_rank_dimension, aligning_variable, do_vanilla_intervention, do_boundless_das, seed, return_intervenable, debug)</span>
<span class="g g-Whitespace">    </span><span class="mi">699</span> <span class="c1"># prepare label</span>
<span class="g g-Whitespace">    </span><span class="mi">700</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">batch_dataset</span><span class="o">.</span><span class="n">patched_answer_tokens</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">701</span>     <span class="n">gpt2</span><span class="o">.</span><span class="n">device</span>
<span class="g g-Whitespace">    </span><span class="mi">702</span> <span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">704</span> <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">18</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">batch_dataset</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">lengths</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">705</span> <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">18</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">batch_dataset</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">lengths</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">707</span> <span class="k">if</span> <span class="n">heads</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

<span class="ne">AssertionError</span>: 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># these lines are comment out since we have run the experiments.</span>
<span class="c1"># df = pd.DataFrame(block_out_data)</span>
<span class="c1"># df.to_csv(&quot;./tutorial_data/block_out_df.csv&quot;)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;./tutorial_data/block_out_df.csv&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;layer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;layer&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;token position&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;IIA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;token position&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;token position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>

<span class="c1"># Use format string to keep two decimal places</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;IIA_label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;IIA&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">block_out_plot</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;token position&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;layer&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_tile</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="s2">&quot;IIA&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">scale_fill_cmap</span><span class="p">(</span><span class="s2">&quot;Purples&quot;</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="o">+</span> <span class="n">geom_text</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;IIA_label&quot;</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">ggtitle</span><span class="p">(</span><span class="s2">&quot;Main Residual Streams&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">ggsave</span><span class="p">(</span><span class="n">block_out_plot</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;./tutorial_data/block_out_plot.pdf&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="n">block_out_plot</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../../_images/e9987d909d2d1b0c83b17b98d174bc4b7b24147e1ba714fd1e9b5b3711262820.png"><img alt="../../_images/e9987d909d2d1b0c83b17b98d174bc4b7b24147e1ba714fd1e9b5b3711262820.png" src="../../_images/e9987d909d2d1b0c83b17b98d174bc4b7b24147e1ba714fd1e9b5b3711262820.png" style="width: 640px; height: 480px;" /></a>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure Size: (640 x 480)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mlp_activation_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="n">positions</span><span class="o">=</span><span class="p">[</span><span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">],</span>
    <span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="n">stream</span><span class="o">=</span><span class="s2">&quot;mlp_activation&quot;</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># df = pd.DataFrame(mlp_activation_data)</span>
<span class="c1"># df.to_csv(&quot;./tutorial_data/mlp_activation_df.csv&quot;)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;./tutorial_data/mlp_activation_df.csv&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;layer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;layer&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;token position&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;pos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;IIA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;token position&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;token position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>

<span class="c1"># Use format string to keep two decimal places</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;IIA_label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;IIA&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">mlp_activaiton_plot</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;token position&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;layer&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_tile</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="s2">&quot;IIA&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">scale_fill_cmap</span><span class="p">(</span><span class="s2">&quot;Greens&quot;</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="o">+</span> <span class="n">geom_text</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;IIA_label&quot;</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">ggtitle</span><span class="p">(</span><span class="s2">&quot;MLP Activations&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">ggsave</span><span class="p">(</span><span class="n">mlp_activaiton_plot</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;./tutorial_data/mlp_activaiton_plot.pdf&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="n">mlp_activaiton_plot</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../../_images/c925fb81fb3b668bf0bc074d8fb475325f8b4ef7c8b86402bacd25af5d35e39f.png"><img alt="../../_images/c925fb81fb3b668bf0bc074d8fb475325f8b4ef7c8b86402bacd25af5d35e39f.png" src="../../_images/c925fb81fb3b668bf0bc074d8fb475325f8b4ef7c8b86402bacd25af5d35e39f.png" style="width: 640px; height: 480px;" /></a>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure Size: (640 x 480)&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="localizing-in-across-multiple-tokens-at-layer-7-one-layer-earlier-than-layer-8">
<h2>Localizing in across multiple tokens at layer 7, one layer earlier than layer 8<a class="headerlink" href="#localizing-in-across-multiple-tokens-at-layer-7-one-layer-earlier-than-layer-8" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">block_out_across_tokens_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">]],</span>
    <span class="p">[</span><span class="mi">7</span><span class="p">],</span>
    <span class="s2">&quot;block_output&quot;</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="localizing-in-different-streams">
<h2>Localizing in different streams<a class="headerlink" href="#localizing-in-different-streams" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">attn_input_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="p">[</span><span class="mi">17</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span> <span class="s2">&quot;attention_input&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">block_input_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="p">[</span><span class="mi">17</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span> <span class="s2">&quot;block_input&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">mlp_input_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="p">[</span><span class="mi">17</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span> <span class="s2">&quot;mlp_input&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">mlp_act_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="p">[</span><span class="mi">17</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span> <span class="s2">&quot;mlp_activation&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">attn_out_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="p">[</span><span class="mi">17</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span> <span class="s2">&quot;attention_output&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">mlp_out_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="p">[</span><span class="mi">17</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span> <span class="s2">&quot;mlp_output&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">attn_value_out_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="p">[</span><span class="mi">17</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span> <span class="s2">&quot;attention_value_output&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">block_output_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="p">[</span><span class="mi">17</span><span class="p">],</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span> <span class="s2">&quot;block_output&quot;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_streams_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;./tutorial_data/all_streams_df.csv&quot;</span><span class="p">)</span>
<span class="n">all_streams_df</span><span class="p">[</span><span class="s2">&quot;IIA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_streams_df</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">all_streams_df</span><span class="p">[</span>
    <span class="n">all_streams_df</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;block_output&quot;</span><span class="p">,</span>
            <span class="s2">&quot;attention_input&quot;</span><span class="p">,</span>
            <span class="s2">&quot;attention_output&quot;</span><span class="p">,</span>
            <span class="s2">&quot;attention_value_output&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
<span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">stream_labels</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;block_output&quot;</span><span class="p">:</span> <span class="s2">&quot;Block Output&quot;</span><span class="p">,</span>
    <span class="s2">&quot;attention_input&quot;</span><span class="p">:</span> <span class="s2">&quot;Attention Input&quot;</span><span class="p">,</span>
    <span class="s2">&quot;attention_output&quot;</span><span class="p">:</span> <span class="s2">&quot;Attention Output</span><span class="se">\n</span><span class="s2">(After Head Mixing)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;attention_value_output&quot;</span><span class="p">:</span> <span class="s2">&quot;Attention Value Output</span><span class="se">\n</span><span class="s2">(Before Head Mixing)&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;stream&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">stream_labels</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">custom_format</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;IIA_formatted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;IIA&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">custom_format</span><span class="p">)</span>
<span class="n">other_locations_plot</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;layer&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;IIA&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;stream&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_line</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">geom_point</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_text</span><span class="p">(</span>
        <span class="n">aes</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;IIA_formatted&quot;</span><span class="p">),</span> <span class="n">nudge_y</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">show_legend</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_minimal</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.72</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">ggtitle</span><span class="p">(</span><span class="s2">&quot;Name Position w/ A Single DAS Direction&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">ggsave</span><span class="p">(</span>
    <span class="n">other_locations_plot</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;./tutorial_data/other_locations_plot.pdf&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span>
<span class="p">)</span>
<span class="n">other_locations_plot</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../../_images/4eb1fdd576890c32323ce9c486fb0d5c982145e923a9902ad268114f8761f307.png"><img alt="../../_images/4eb1fdd576890c32323ce9c486fb0d5c982145e923a9902ad268114f8761f307.png" src="../../_images/4eb1fdd576890c32323ce9c486fb0d5c982145e923a9902ad268114f8761f307.png" style="width: 1200px; height: 300px;" /></a>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure Size: (1200 x 300)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># all_streams_df = pd.DataFrame(</span>
<span class="c1">#     block_output_data+attn_out_data+</span>
<span class="c1">#     mlp_out_data+attn_value_out_data+</span>
<span class="c1">#     mlp_act_data+mlp_input_data+</span>
<span class="c1">#     block_input_data+attn_input_data</span>
<span class="c1"># )</span>
<span class="c1"># all_streams_df.to_csv(&quot;./tutorial_data/all_streams_df.csv&quot;)</span>
<span class="n">all_streams_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;./tutorial_data/all_streams_df.csv&quot;</span><span class="p">)</span>
<span class="n">all_streams_df</span><span class="p">[</span><span class="s2">&quot;IIA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_streams_df</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">all_streams_df</span><span class="p">[</span>
    <span class="n">all_streams_df</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">({</span><span class="s2">&quot;mlp_output&quot;</span><span class="p">,</span> <span class="s2">&quot;mlp_input&quot;</span><span class="p">,</span> <span class="s2">&quot;mlp_activation&quot;</span><span class="p">})</span>
<span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">stream_labels</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;mlp_output&quot;</span><span class="p">:</span> <span class="s2">&quot;MLP Output&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mlp_input&quot;</span><span class="p">:</span> <span class="s2">&quot;MLP Input&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mlp_activation&quot;</span><span class="p">:</span> <span class="s2">&quot;MLP Activations&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">stream_labels</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">custom_format</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="n">df</span><span class="p">[</span><span class="s2">&quot;IIA_formatted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;IIA&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">custom_format</span><span class="p">)</span>
<span class="n">all_mlp_locations_plot</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;layer&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;IIA&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;stream&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_line</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">geom_point</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_text</span><span class="p">(</span>
        <span class="n">aes</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;IIA_formatted&quot;</span><span class="p">),</span> <span class="n">nudge_y</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">show_legend</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_minimal</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.72</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">ggtitle</span><span class="p">(</span><span class="s2">&quot;Name Position w/ A Single DAS Direction&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">ggsave</span><span class="p">(</span>
    <span class="n">all_mlp_locations_plot</span><span class="p">,</span>
    <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;./tutorial_data/all_mlp_locations_plot.pdf&quot;</span><span class="p">,</span>
    <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">all_mlp_locations_plot</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../../_images/a9d681777ff4189db56e2333de5b721197ed39bd911b039af373c2084f2b9444.png"><img alt="../../_images/a9d681777ff4189db56e2333de5b721197ed39bd911b039af373c2084f2b9444.png" src="../../_images/a9d681777ff4189db56e2333de5b721197ed39bd911b039af373c2084f2b9444.png" style="width: 1200px; height: 300px;" /></a>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure Size: (1200 x 300)&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="localizing-in-each-individual-head-at-layer-7-and-8">
<h2>Localizing in each individual head at layer 7 and 8<a class="headerlink" href="#localizing-in-each-individual-head-at-layer-7-and-8" title="Link to this heading">#</a></h2>
<p>We further investigate whether any heads in the 7th and 8th layers specialize in name position information. Note that we consider each head individually in this analysis. Therefore, if the name position information is distributed across tokens, it would not be detectable in this context.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">head_attn_value_out_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
    <span class="n">_head_attn_value_out_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
        <span class="n">gpt2</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="p">[</span><span class="mi">17</span><span class="p">],</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="s2">&quot;head_attention_value_output&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">h</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">head_attn_value_out_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_head_attn_value_out_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">head_attn_value_out_data</span><span class="p">)</span>

<span class="n">plot</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;layer&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;acc&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;stream&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_line</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">geom_point</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_minimal</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">plot</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="localizing-with-group-of-heads-using-rankings-of-missing-out-head-iia">
<h2>Localizing with group of heads using rankings of missing out head IIA<a class="headerlink" href="#localizing-with-group-of-heads-using-rankings-of-missing-out-head-iia" title="Link to this heading">#</a></h2>
<p>When examining each individual head, localizing the name position information was not possible. Why is this? The information is likely distributed across multiple heads. To further investigate, let’s perform an additional check by localizing in the concatenated head representations, leaving only one head out at a time. We leave one head out to determine if omitting specific heads results in significant drops in IIA.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">layer</span> <span class="o">=</span> <span class="mi">7</span>

<span class="n">head_attn_value_out_mo_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;evaluating grouped IIA without head&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">_head_attn_value_out_mo_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
        <span class="n">gpt2</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">,</span>
        <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
        <span class="p">[</span><span class="n">layer</span><span class="p">],</span>
        <span class="s2">&quot;head_attention_value_output&quot;</span><span class="p">,</span>
        <span class="n">heads</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)])</span> <span class="o">-</span> <span class="p">{</span><span class="n">i</span><span class="p">}),</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">_head_attn_value_out_mo_data</span><span class="p">[</span><span class="s2">&quot;mo_head&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
    <span class="n">head_attn_value_out_mo_data</span> <span class="o">+=</span> <span class="p">[</span><span class="n">_head_attn_value_out_mo_data</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">head_rank_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">anchor_acc</span> <span class="o">=</span> <span class="mf">0.48</span>
<span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">head_attn_value_out_mo_data</span><span class="p">:</span>
    <span class="n">head_rank_list</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;mo_head&quot;</span><span class="p">],</span> <span class="n">anchor_acc</span> <span class="o">-</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">])]</span>
<span class="n">head_rank_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">head_rank_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">head_attn_value_out_mo_data</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;mo_head_cat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mo_head&quot;</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;mo_head&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">head_drop_plot</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;mo_head_cat&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;acc&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;mo_head&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_bar</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s2">&quot;identity&quot;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="s2">&quot;dodge&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Leave-One-Out (LOO) Head Index (</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">th Layer)&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;IIA&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_minimal</span><span class="p">()</span>  <span class="c1"># Add axis labels</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># Use a minimal theme</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">legend_position</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">scale_x_discrete</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;head </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mo_head&quot;</span><span class="p">]])</span>
<span class="p">)</span>

<span class="n">ggsave</span><span class="p">(</span>
    <span class="n">head_drop_plot</span><span class="p">,</span>
    <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;./tutorial_data/layer_</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">_head_drop_plot.pdf&quot;</span><span class="p">,</span>
    <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">head_drop_plot</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">head_attn_value_out_cumulative_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">current_heads</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">head_rank_list</span><span class="p">:</span>
    <span class="n">current_heads</span> <span class="o">+=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;evaluating grouped IIA adding head&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">_head_attn_value_out_cumulative_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
        <span class="n">gpt2</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">,</span>
        <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
        <span class="p">[</span><span class="n">layer</span><span class="p">],</span>
        <span class="s2">&quot;head_attention_value_output&quot;</span><span class="p">,</span>
        <span class="n">heads</span><span class="o">=</span><span class="n">current_heads</span><span class="p">,</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">_head_attn_value_out_cumulative_data</span><span class="p">[</span><span class="s2">&quot;adding_head&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">head_attn_value_out_cumulative_data</span> <span class="o">+=</span> <span class="p">[</span><span class="n">_head_attn_value_out_cumulative_data</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">head_attn_value_out_cumulative_data</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;adding_head_cat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;adding_head&quot;</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;adding_head&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="n">head_acc_plot</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;adding_head_cat&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;acc&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;adding_head&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_bar</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s2">&quot;identity&quot;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="s2">&quot;dodge&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Cumulative Head Index (</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">th Layer)&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;IIA&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_minimal</span><span class="p">()</span>  <span class="c1"># Add axis labels</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># Use a minimal theme</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">legend_position</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">scale_x_discrete</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;+ head </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;adding_head&quot;</span><span class="p">]])</span>
<span class="p">)</span>

<span class="n">ggsave</span><span class="p">(</span>
    <span class="n">head_acc_plot</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;./tutorial_data/layer_</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">_head_acc_plot.pdf&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span>
<span class="p">)</span>
<span class="n">head_acc_plot</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="localizing-the-correct-io-name-with-vanilla-causal-abstraction-no-training">
<h2>Localizing the correct IO name with vanilla causal abstraction (no training)<a class="headerlink" href="#localizing-the-correct-io-name-with-vanilla-causal-abstraction-no-training" title="Link to this heading">#</a></h2>
<p>We can further localize the correct IO name in the output streams. We use vanilla interchange intervention, so there is no training just activation swap.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">attn_input_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;attention_input&quot;</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>  <span class="c1"># now we are localizing the IO name</span>
    <span class="n">do_vanilla_intervention</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># we avoid learning DAS for this since outspace is large here.</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">block_input_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;block_input&quot;</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
    <span class="n">do_vanilla_intervention</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">mlp_input_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;mlp_input&quot;</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
    <span class="n">do_vanilla_intervention</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">mlp_act_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;mlp_activation&quot;</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
    <span class="n">do_vanilla_intervention</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">attn_out_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;attention_output&quot;</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
    <span class="n">do_vanilla_intervention</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">mlp_out_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;mlp_output&quot;</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
    <span class="n">do_vanilla_intervention</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">attn_value_out_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;attention_value_output&quot;</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
    <span class="n">do_vanilla_intervention</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">block_output_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;block_output&quot;</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
    <span class="n">do_vanilla_intervention</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_streams_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">block_output_data</span>
    <span class="o">+</span> <span class="n">attn_out_data</span>
    <span class="o">+</span> <span class="n">mlp_out_data</span>
    <span class="o">+</span> <span class="n">attn_value_out_data</span>
    <span class="o">+</span> <span class="n">mlp_act_data</span>
    <span class="o">+</span> <span class="n">mlp_input_data</span>
    <span class="o">+</span> <span class="n">block_input_data</span>
    <span class="o">+</span> <span class="n">attn_input_data</span>
<span class="p">)</span>
<span class="n">all_streams_df</span><span class="p">[</span><span class="s2">&quot;IIA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_streams_df</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">all_streams_df</span><span class="p">[</span>
    <span class="n">all_streams_df</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;block_output&quot;</span><span class="p">,</span>
            <span class="s2">&quot;attention_input&quot;</span><span class="p">,</span>
            <span class="s2">&quot;attention_output&quot;</span><span class="p">,</span>
            <span class="s2">&quot;attention_value_output&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
<span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">stream_labels</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;block_output&quot;</span><span class="p">:</span> <span class="s2">&quot;Block Output&quot;</span><span class="p">,</span>
    <span class="s2">&quot;attention_input&quot;</span><span class="p">:</span> <span class="s2">&quot;Attention Input&quot;</span><span class="p">,</span>
    <span class="s2">&quot;attention_output&quot;</span><span class="p">:</span> <span class="s2">&quot;Attention Output</span><span class="se">\n</span><span class="s2">(After Head Mixing)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;attention_value_output&quot;</span><span class="p">:</span> <span class="s2">&quot;Attention Value Output</span><span class="se">\n</span><span class="s2">(Before Head Mixing)&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">stream_labels</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">custom_format</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="n">df</span><span class="p">[</span><span class="s2">&quot;IIA_formatted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;IIA&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">custom_format</span><span class="p">)</span>
<span class="n">other_locations_plot</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;layer&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;IIA&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;stream&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_line</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">geom_point</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_text</span><span class="p">(</span>
        <span class="n">aes</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;IIA_formatted&quot;</span><span class="p">),</span> <span class="n">nudge_y</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">show_legend</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_minimal</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">ggtitle</span><span class="p">(</span><span class="s2">&quot;Correct IO Name (20) w/ Interchange Intervention (Original Basis)&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">ggsave</span><span class="p">(</span>
    <span class="n">other_locations_plot</span><span class="p">,</span>
    <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;./tutorial_data/IO_name_other_locations_plot.pdf&quot;</span><span class="p">,</span>
    <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">other_locations_plot</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../../_images/495a39be446770714619153e861d9e48c1e50e473bbb070647af3440a710b058.png"><img alt="../../_images/495a39be446770714619153e861d9e48c1e50e473bbb070647af3440a710b058.png" src="../../_images/495a39be446770714619153e861d9e48c1e50e473bbb070647af3440a710b058.png" style="width: 1200px; height: 300px;" /></a>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure Size: (1200 x 300)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_streams_df</span><span class="p">[</span><span class="s2">&quot;IIA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_streams_df</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">all_streams_df</span><span class="p">[</span>
    <span class="n">all_streams_df</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">({</span><span class="s2">&quot;mlp_output&quot;</span><span class="p">,</span> <span class="s2">&quot;mlp_input&quot;</span><span class="p">,</span> <span class="s2">&quot;mlp_activation&quot;</span><span class="p">})</span>
<span class="p">]</span>
<span class="n">stream_labels</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;mlp_output&quot;</span><span class="p">:</span> <span class="s2">&quot;MLP Output&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mlp_input&quot;</span><span class="p">:</span> <span class="s2">&quot;MLP Input&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mlp_activation&quot;</span><span class="p">:</span> <span class="s2">&quot;MLP Activations&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">stream_labels</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">custom_format</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="n">df</span><span class="p">[</span><span class="s2">&quot;IIA_formatted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;IIA&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">custom_format</span><span class="p">)</span>
<span class="n">all_mlp_locations_plot</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;layer&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;IIA&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;stream&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_line</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">geom_point</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_text</span><span class="p">(</span>
        <span class="n">aes</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;IIA_formatted&quot;</span><span class="p">),</span> <span class="n">nudge_y</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">show_legend</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_minimal</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.72</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">ggtitle</span><span class="p">(</span><span class="s2">&quot;Correct IO Name (20) w/ Interchange Intervention (Original Basis)&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">ggsave</span><span class="p">(</span>
    <span class="n">all_mlp_locations_plot</span><span class="p">,</span>
    <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;./tutorial_data/IO_name_all_mlp_locations_plot.pdf&quot;</span><span class="p">,</span>
    <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">all_mlp_locations_plot</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../../_images/3cb60b7e6e568804c2e8855e0d2c1bba450a304fe8221e2c5cc2d6fbb175439e.png"><img alt="../../_images/3cb60b7e6e568804c2e8855e0d2c1bba450a304fe8221e2c5cc2d6fbb175439e.png" src="../../_images/3cb60b7e6e568804c2e8855e0d2c1bba450a304fe8221e2c5cc2d6fbb175439e.png" style="width: 1200px; height: 300px;" /></a>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure Size: (1200 x 300)&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="localizing-the-correct-io-name-with-das-20-names-only-with-20-dimension-das">
<h2>Localizing the correct IO name with DAS (20 names only with 20 dimension DAS)<a class="headerlink" href="#localizing-the-correct-io-name-with-das-20-names-only-with-20-dimension-das" title="Link to this heading">#</a></h2>
<p>We now localize the IO name with DAS. To make things easier, we restrict the dataset to contain 20 distinct names. Training and evaluation share the same set of names. We use a fixed dimension size of 20 for DAS training. Everything else is kept the same as previous experiments.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">attn_input_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;attention_input&quot;</span><span class="p">,</span>
    <span class="n">low_rank_dimension</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>  <span class="c1"># now we are localizing the IO name</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">block_input_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;block_input&quot;</span><span class="p">,</span>
    <span class="n">low_rank_dimension</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">mlp_input_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;mlp_input&quot;</span><span class="p">,</span>
    <span class="n">low_rank_dimension</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">mlp_act_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;mlp_activation&quot;</span><span class="p">,</span>
    <span class="n">low_rank_dimension</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">attn_out_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;attention_output&quot;</span><span class="p">,</span>
    <span class="n">low_rank_dimension</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">mlp_out_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;mlp_output&quot;</span><span class="p">,</span>
    <span class="n">low_rank_dimension</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">attn_value_out_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;attention_value_output&quot;</span><span class="p">,</span>
    <span class="n">low_rank_dimension</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">block_output_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;block_output&quot;</span><span class="p">,</span>
    <span class="n">low_rank_dimension</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># all_streams_io_name_df = pd.DataFrame(</span>
<span class="c1">#     block_output_data+</span>
<span class="c1">#     attn_out_data+mlp_out_data+</span>
<span class="c1">#     attn_value_out_data+mlp_act_data+</span>
<span class="c1">#     mlp_input_data+block_input_data+attn_input_data</span>
<span class="c1"># )</span>
<span class="c1"># all_streams_io_name_df.to_csv(&quot;./tutorial_data/all_streams_io_name_df.csv&quot;)</span>
<span class="n">all_streams_io_name_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;./tutorial_data/all_streams_io_name_df.csv&quot;</span><span class="p">)</span>
<span class="n">all_streams_io_name_df</span><span class="p">[</span><span class="s2">&quot;IIA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_streams_io_name_df</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">all_streams_io_name_df</span><span class="p">[</span>
    <span class="n">all_streams_io_name_df</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;block_output&quot;</span><span class="p">,</span>
            <span class="s2">&quot;attention_input&quot;</span><span class="p">,</span>
            <span class="s2">&quot;attention_output&quot;</span><span class="p">,</span>
            <span class="s2">&quot;attention_value_output&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
<span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">stream_labels</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;block_output&quot;</span><span class="p">:</span> <span class="s2">&quot;Block Output&quot;</span><span class="p">,</span>
    <span class="s2">&quot;attention_input&quot;</span><span class="p">:</span> <span class="s2">&quot;Attention Input&quot;</span><span class="p">,</span>
    <span class="s2">&quot;attention_output&quot;</span><span class="p">:</span> <span class="s2">&quot;Attention Output</span><span class="se">\n</span><span class="s2">(After Head Mixing)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;attention_value_output&quot;</span><span class="p">:</span> <span class="s2">&quot;Attention Value Output</span><span class="se">\n</span><span class="s2">(Before Head Mixing)&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">stream_labels</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">custom_format</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="n">df</span><span class="p">[</span><span class="s2">&quot;IIA_formatted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;IIA&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">custom_format</span><span class="p">)</span>
<span class="n">other_locations_plot</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;layer&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;IIA&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;stream&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_line</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">geom_point</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_text</span><span class="p">(</span>
        <span class="n">aes</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;IIA_formatted&quot;</span><span class="p">),</span> <span class="n">nudge_y</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">show_legend</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_minimal</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">ggtitle</span><span class="p">(</span><span class="s2">&quot;Correct IO Name (20) w/ DAS (Learned Basis)&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">ggsave</span><span class="p">(</span>
    <span class="n">other_locations_plot</span><span class="p">,</span>
    <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;./tutorial_data/DAS_IO_name_other_locations_plot.pdf&quot;</span><span class="p">,</span>
    <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">other_locations_plot</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../../_images/740112e374c50c87fcb4b353651e3ac260de0b8a13531f8bd108f57633bd1a70.png"><img alt="../../_images/740112e374c50c87fcb4b353651e3ac260de0b8a13531f8bd108f57633bd1a70.png" src="../../_images/740112e374c50c87fcb4b353651e3ac260de0b8a13531f8bd108f57633bd1a70.png" style="width: 1200px; height: 300px;" /></a>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure Size: (1200 x 300)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># all_streams_df = pd.DataFrame(</span>
<span class="c1">#     block_output_data+attn_out_data+</span>
<span class="c1">#     mlp_out_data+attn_value_out_data+</span>
<span class="c1">#     mlp_act_data+mlp_input_data+</span>
<span class="c1">#     block_input_data+attn_input_data</span>
<span class="c1"># )</span>
<span class="c1"># all_streams_df.to_csv(&quot;./tutorial_data/all_streams_df.csv&quot;)</span>
<span class="n">all_streams_io_name_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;./tutorial_data/all_streams_io_name_df.csv&quot;</span><span class="p">)</span>
<span class="n">all_streams_io_name_df</span><span class="p">[</span><span class="s2">&quot;IIA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_streams_io_name_df</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">all_streams_io_name_df</span><span class="p">[</span>
    <span class="n">all_streams_io_name_df</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">({</span><span class="s2">&quot;mlp_output&quot;</span><span class="p">,</span> <span class="s2">&quot;mlp_input&quot;</span><span class="p">,</span> <span class="s2">&quot;mlp_activation&quot;</span><span class="p">})</span>
<span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">stream_labels</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;mlp_output&quot;</span><span class="p">:</span> <span class="s2">&quot;MLP Output&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mlp_input&quot;</span><span class="p">:</span> <span class="s2">&quot;MLP Input&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mlp_activation&quot;</span><span class="p">:</span> <span class="s2">&quot;MLP Activations&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">stream_labels</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">custom_format</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="n">df</span><span class="p">[</span><span class="s2">&quot;IIA_formatted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;IIA&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">custom_format</span><span class="p">)</span>
<span class="n">all_mlp_locations_plot</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;layer&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;IIA&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;stream&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_line</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">geom_point</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_text</span><span class="p">(</span>
        <span class="n">aes</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;IIA_formatted&quot;</span><span class="p">),</span> <span class="n">nudge_y</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">show_legend</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_minimal</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.72</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">ggtitle</span><span class="p">(</span><span class="s2">&quot;Name Position w/ DAS (Learned Basis)&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">ggsave</span><span class="p">(</span>
    <span class="n">all_mlp_locations_plot</span><span class="p">,</span>
    <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;./tutorial_data/DAS_IO_name_all_mlp_locations_plot.pdf&quot;</span><span class="p">,</span>
    <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">all_mlp_locations_plot</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../../_images/ce52c762453051be57d204f305737df463b4a354458359246906815a0b49aed2.png"><img alt="../../_images/ce52c762453051be57d204f305737df463b4a354458359246906815a0b49aed2.png" src="../../_images/ce52c762453051be57d204f305737df463b4a354458359246906815a0b49aed2.png" style="width: 1200px; height: 300px;" /></a>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure Size: (1200 x 300)&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="head-s-query-representations-to-trace-name-mover-head">
<h2>Head’s Query Representations to Trace Name Mover Head<a class="headerlink" href="#head-s-query-representations-to-trace-name-mover-head" title="Link to this heading">#</a></h2>
<p>To use the name position information to copy the IO name, responsible heads need to take in name position information, and process it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">layer</span> <span class="o">=</span> <span class="mi">9</span>
<span class="n">head_query_output_mo_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
    <span class="n">_head_query_output_mo_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
        <span class="n">gpt2</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">,</span>
        <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
        <span class="p">[</span><span class="n">layer</span><span class="p">],</span>
        <span class="s2">&quot;head_query_output&quot;</span><span class="p">,</span>
        <span class="n">heads</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)])</span> <span class="o">-</span> <span class="p">{</span><span class="n">i</span><span class="p">})),</span>
        <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">_head_query_output_mo_data</span><span class="p">[</span><span class="s2">&quot;mo_head&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
    <span class="n">head_query_output_mo_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_head_query_output_mo_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">layer</span> <span class="o">=</span> <span class="mi">9</span>
<span class="c1"># df = pd.DataFrame(head_query_output_mo_data)</span>
<span class="c1"># df.to_csv(f&quot;./tutorial_data/layer_{layer}_head_query_output_mo_data.csv&quot;)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;./tutorial_data/layer_</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">_head_query_output_mo_data.csv&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;mo_head_cat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mo_head&quot;</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;mo_head&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">head_query_output_mo_plot</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;mo_head_cat&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;acc&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;mo_head&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_bar</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s2">&quot;identity&quot;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="s2">&quot;dodge&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Leave-One-Out (LOO) Head Index (</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">th Layer)&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;IIA&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_minimal</span><span class="p">()</span>  <span class="c1"># Add axis labels</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># Use a minimal theme</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">legend_position</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">scale_x_discrete</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;head </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mo_head&quot;</span><span class="p">]])</span>
    <span class="o">+</span> <span class="n">ggtitle</span><span class="p">(</span><span class="s2">&quot;Name Position for Each Head (Query) Before Self-Attention&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">ggsave</span><span class="p">(</span>
    <span class="n">head_query_output_mo_plot</span><span class="p">,</span>
    <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;./tutorial_data/layer_</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">_head_query_output_mo_plot.pdf&quot;</span><span class="p">,</span>
    <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">head_query_output_mo_plot</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../../_images/ae5f93b8f042d6e571475d7de414286eaf6214da23944a580baae06ce44a2b52.png"><img alt="../../_images/ae5f93b8f042d6e571475d7de414286eaf6214da23944a580baae06ce44a2b52.png" src="../../_images/ae5f93b8f042d6e571475d7de414286eaf6214da23944a580baae06ce44a2b52.png" style="width: 1000px; height: 200px;" /></a>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure Size: (1000 x 200)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">head_attention_value_output_mo_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
    <span class="n">_head_attention_value_output_mo_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
        <span class="n">gpt2</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">,</span>
        <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
        <span class="p">[</span><span class="n">layer</span><span class="p">],</span>
        <span class="s2">&quot;head_attention_value_output&quot;</span><span class="p">,</span>
        <span class="n">heads</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)])</span> <span class="o">-</span> <span class="p">{</span><span class="n">i</span><span class="p">})),</span>
        <span class="n">low_rank_dimension</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
        <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">_head_attention_value_output_mo_data</span><span class="p">[</span><span class="s2">&quot;mo_head&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
    <span class="n">head_attention_value_output_mo_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_head_attention_value_output_mo_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># df = pd.DataFrame(head_attention_value_output_mo_data)</span>
<span class="c1"># df.to_csv(f&quot;./tutorial_data/layer_{layer}_head_attention_value_output_mo_data.csv&quot;)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;./tutorial_data/layer_</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">_head_attention_value_output_mo_data.csv&quot;</span>
<span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;mo_head_cat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mo_head&quot;</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;mo_head&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">head_attention_value_output_mo_plot</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;mo_head_cat&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;acc&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;mo_head&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_bar</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s2">&quot;identity&quot;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="s2">&quot;dodge&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Leave-One-Out (LOO) Head Index (</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">th Layer)&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;IIA&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_minimal</span><span class="p">()</span>  <span class="c1"># Add axis labels</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># Use a minimal theme</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">legend_position</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">scale_x_discrete</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;head </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mo_head&quot;</span><span class="p">]])</span>
    <span class="o">+</span> <span class="n">ggtitle</span><span class="p">(</span><span class="s2">&quot;IO Name for Each Head (Value) after Self-Attention&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">ggsave</span><span class="p">(</span>
    <span class="n">head_attention_value_output_mo_plot</span><span class="p">,</span>
    <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;./tutorial_data/layer_</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">_head_attention_value_output_mo_plot.pdf&quot;</span><span class="p">,</span>
    <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">head_attention_value_output_mo_plot</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../../_images/86c810bf678fbd3cbf2ecdc10ed0ce804528334e27db0ca51a198a7bf625e417.png"><img alt="../../_images/86c810bf678fbd3cbf2ecdc10ed0ce804528334e27db0ca51a198a7bf625e417.png" src="../../_images/86c810bf678fbd3cbf2ecdc10ed0ce804528334e27db0ca51a198a7bf625e417.png" style="width: 1000px; height: 200px;" /></a>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure Size: (1000 x 200)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">head_attn_value_out_cumulative_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">current_heads</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">]:</span>
    <span class="n">current_heads</span> <span class="o">+=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;evaluating grouped IIA adding head&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">_head_attn_value_out_cumulative_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
        <span class="n">gpt2</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">,</span>
        <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
        <span class="p">[</span><span class="n">layer</span><span class="p">],</span>
        <span class="s2">&quot;head_attention_value_output&quot;</span><span class="p">,</span>
        <span class="n">heads</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">current_heads</span><span class="p">),</span>
        <span class="n">low_rank_dimension</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
        <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">_head_attn_value_out_cumulative_data</span><span class="p">[</span><span class="s2">&quot;adding_head&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
    <span class="n">head_attn_value_out_cumulative_data</span> <span class="o">+=</span> <span class="p">[</span><span class="n">_head_attn_value_out_cumulative_data</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># df = pd.DataFrame(head_attn_value_out_cumulative_data)</span>
<span class="c1"># df.to_csv(f&quot;./tutorial_data/DAS_IO_layer_{layer}_head_attn_value_out_cumulative_data.csv&quot;)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;./tutorial_data/DAS_IO_layer_</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">_head_attn_value_out_cumulative_data.csv&quot;</span>
<span class="p">)</span>

<span class="n">df</span><span class="p">[</span><span class="s2">&quot;adding_head_cat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;adding_head&quot;</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;adding_head&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="n">head_acc_plot</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;adding_head_cat&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;acc&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;adding_head&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_bar</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s2">&quot;identity&quot;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="s2">&quot;dodge&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Cumulative Head Index (</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">th Layer)&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;IIA&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_minimal</span><span class="p">()</span>  <span class="c1"># Add axis labels</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># Use a minimal theme</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">legend_position</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">scale_x_discrete</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;+ head </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;adding_head&quot;</span><span class="p">]])</span>
    <span class="o">+</span> <span class="n">ggtitle</span><span class="p">(</span><span class="s2">&quot;IO Name for Cumulative Head (Value) after Self-Attention&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">ggsave</span><span class="p">(</span>
    <span class="n">head_acc_plot</span><span class="p">,</span>
    <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;./tutorial_data/DAS_IO_layer_</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">_head_attn_value_out_cumulative_plot.pdf&quot;</span><span class="p">,</span>
    <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">head_acc_plot</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../../_images/c0f343f8181fac70426959817b6d7bed20fbbf9e2ced923bd60af5ae3dd76796.png"><img alt="../../_images/c0f343f8181fac70426959817b6d7bed20fbbf9e2ced923bd60af5ae3dd76796.png" src="../../_images/c0f343f8181fac70426959817b6d7bed20fbbf9e2ced923bd60af5ae3dd76796.png" style="width: 1000px; height: 200px;" /></a>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure Size: (1000 x 200)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">layer</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">head_query_output_mo_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
    <span class="n">_head_query_output_mo_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
        <span class="n">gpt2</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">,</span>
        <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
        <span class="p">[</span><span class="n">layer</span><span class="p">],</span>
        <span class="s2">&quot;head_query_output&quot;</span><span class="p">,</span>
        <span class="n">heads</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)])</span> <span class="o">-</span> <span class="p">{</span><span class="n">i</span><span class="p">})),</span>
        <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">_head_query_output_mo_data</span><span class="p">[</span><span class="s2">&quot;mo_head&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
    <span class="n">head_query_output_mo_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_head_query_output_mo_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">layer</span> <span class="o">=</span> <span class="mi">10</span>
<span class="c1"># df = pd.DataFrame(head_query_output_mo_data)</span>
<span class="c1"># df.to_csv(f&quot;./tutorial_data/layer_{layer}_head_query_output_mo_data.csv&quot;)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;./tutorial_data/layer_</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">_head_query_output_mo_data.csv&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;mo_head_cat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mo_head&quot;</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;mo_head&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">head_query_output_mo_plot</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;mo_head_cat&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;acc&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;mo_head&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_bar</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s2">&quot;identity&quot;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="s2">&quot;dodge&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Leave-One-Out (LOO) Head Index (</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">th Layer)&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;IIA&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_minimal</span><span class="p">()</span>  <span class="c1"># Add axis labels</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># Use a minimal theme</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">legend_position</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">scale_x_discrete</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;head </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mo_head&quot;</span><span class="p">]])</span>
    <span class="o">+</span> <span class="n">ggtitle</span><span class="p">(</span><span class="s2">&quot;Name Position for Each Head (Query) Before Self-Attention&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">ggsave</span><span class="p">(</span>
    <span class="n">head_query_output_mo_plot</span><span class="p">,</span>
    <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;./tutorial_data/layer_</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">_head_query_output_mo_plot.pdf&quot;</span><span class="p">,</span>
    <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">head_query_output_mo_plot</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../../_images/b43cebf3af23ff11bba516655e0bdd08a79ea3da27bb9f48ced1527e36bf87e8.png"><img alt="../../_images/b43cebf3af23ff11bba516655e0bdd08a79ea3da27bb9f48ced1527e36bf87e8.png" src="../../_images/b43cebf3af23ff11bba516655e0bdd08a79ea3da27bb9f48ced1527e36bf87e8.png" style="width: 1000px; height: 200px;" /></a>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure Size: (1000 x 200)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">head_attention_value_output_mo_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
    <span class="n">_head_attention_value_output_mo_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
        <span class="n">gpt2</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">,</span>
        <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
        <span class="p">[</span><span class="n">layer</span><span class="p">],</span>
        <span class="s2">&quot;head_attention_value_output&quot;</span><span class="p">,</span>
        <span class="n">heads</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)])</span> <span class="o">-</span> <span class="p">{</span><span class="n">i</span><span class="p">})),</span>
        <span class="n">low_rank_dimension</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
        <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">_head_attention_value_output_mo_data</span><span class="p">[</span><span class="s2">&quot;mo_head&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
    <span class="n">head_attention_value_output_mo_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_head_attention_value_output_mo_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># df = pd.DataFrame(head_attention_value_output_mo_data)</span>
<span class="c1"># df.to_csv(f&quot;./tutorial_data/layer_{layer}_head_attention_value_output_mo_data.csv&quot;)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;./tutorial_data/layer_</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">_head_attention_value_output_mo_data.csv&quot;</span>
<span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;mo_head_cat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mo_head&quot;</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;mo_head&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">head_attention_value_output_mo_plot</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;mo_head_cat&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;acc&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;mo_head&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_bar</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s2">&quot;identity&quot;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="s2">&quot;dodge&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Leave-One-Out (LOO) Head Index (</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">th Layer)&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;IIA&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_minimal</span><span class="p">()</span>  <span class="c1"># Add axis labels</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># Use a minimal theme</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">legend_position</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">scale_x_discrete</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;head </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mo_head&quot;</span><span class="p">]])</span>
    <span class="o">+</span> <span class="n">ggtitle</span><span class="p">(</span><span class="s2">&quot;IO Name for Each Head (Value) after Self-Attention&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">ggsave</span><span class="p">(</span>
    <span class="n">head_attention_value_output_mo_plot</span><span class="p">,</span>
    <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;./tutorial_data/layer_</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">_head_attention_value_output_mo_plot.pdf&quot;</span><span class="p">,</span>
    <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">head_attention_value_output_mo_plot</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../../_images/92151326e27ed27ba1ef81367138fc690c27f638f7366c58e68dea69e26ec6d4.png"><img alt="../../_images/92151326e27ed27ba1ef81367138fc690c27f638f7366c58e68dea69e26ec6d4.png" src="../../_images/92151326e27ed27ba1ef81367138fc690c27f638f7366c58e68dea69e26ec6d4.png" style="width: 1000px; height: 200px;" /></a>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure Size: (1000 x 200)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">head_attn_value_out_cumulative_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">current_heads</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">]:</span>
    <span class="n">current_heads</span> <span class="o">+=</span> <span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;evaluating grouped IIA adding head&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">_head_attn_value_out_cumulative_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
        <span class="n">gpt2</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="p">,</span>
        <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
        <span class="p">[</span><span class="n">layer</span><span class="p">],</span>
        <span class="s2">&quot;head_attention_value_output&quot;</span><span class="p">,</span>
        <span class="n">heads</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="n">current_heads</span><span class="p">),</span>
        <span class="n">low_rank_dimension</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
        <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
        <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">_head_attn_value_out_cumulative_data</span><span class="p">[</span><span class="s2">&quot;adding_head&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
    <span class="n">head_attn_value_out_cumulative_data</span> <span class="o">+=</span> <span class="p">[</span><span class="n">_head_attn_value_out_cumulative_data</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># df = pd.DataFrame(head_attn_value_out_cumulative_data)</span>
<span class="c1"># df.to_csv(f&quot;./tutorial_data/DAS_IO_layer_{layer}_head_attn_value_out_cumulative_data.csv&quot;)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="sa">f</span><span class="s2">&quot;./tutorial_data/DAS_IO_layer_</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">_head_attn_value_out_cumulative_data.csv&quot;</span>
<span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;adding_head_cat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;adding_head&quot;</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;adding_head&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">head_acc_plot</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;adding_head_cat&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;acc&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;adding_head&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_bar</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="s2">&quot;identity&quot;</span><span class="p">,</span> <span class="n">position</span><span class="o">=</span><span class="s2">&quot;dodge&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Cumulative Head Index (</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">th Layer)&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;IIA&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_minimal</span><span class="p">()</span>  <span class="c1"># Add axis labels</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># Use a minimal theme</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">legend_position</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">scale_x_discrete</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;+ head </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;adding_head&quot;</span><span class="p">]])</span>
    <span class="o">+</span> <span class="n">ggtitle</span><span class="p">(</span><span class="s2">&quot;IO Name for Cumulative Head (Value) after Self-Attention&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">ggsave</span><span class="p">(</span>
    <span class="n">head_acc_plot</span><span class="p">,</span>
    <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;./tutorial_data/DAS_IO_layer_</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">_head_attn_value_out_cumulative_plot.pdf&quot;</span><span class="p">,</span>
    <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">head_acc_plot</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../../_images/8f403b7248becfbb27ca726da099de64aab46a69a5d1c210a44c9f1c9afcc058.png"><img alt="../../_images/8f403b7248becfbb27ca726da099de64aab46a69a5d1c210a44c9f1c9afcc058.png" src="../../_images/8f403b7248becfbb27ca726da099de64aab46a69a5d1c210a44c9f1c9afcc058.png" style="width: 1000px; height: 200px;" /></a>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure Size: (1000 x 200)&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="use-boundless-das-to-find-information">
<h2>Use Boundless DAS to find information<a class="headerlink" href="#use-boundless-das-to-find-information" title="Link to this heading">#</a></h2>
<p>Instead of starting with a fixed number of DAS dimension, we can also use Boundless DAS (Wu et. al., 2023) to dynamically find a good dimension by learning the boundary. Here, we use Boundless DAS to find alignments for the name position information variable as well as the correct IO name variable. Very similar results, yet alignments with the IO name seems to be consistently better.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">attn_input_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;attention_input&quot;</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">,</span>  <span class="c1"># now we are localizing the IO name</span>
    <span class="n">do_boundless_das</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">block_input_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;block_input&quot;</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">,</span>
    <span class="n">do_boundless_das</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">mlp_input_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;mlp_input&quot;</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">,</span>
    <span class="n">do_boundless_das</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">mlp_act_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;mlp_activation&quot;</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">,</span>
    <span class="n">do_boundless_das</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">attn_out_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;attention_output&quot;</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">,</span>
    <span class="n">do_boundless_das</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">mlp_out_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;mlp_output&quot;</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">,</span>
    <span class="n">do_boundless_das</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">attn_value_out_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;attention_value_output&quot;</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">,</span>
    <span class="n">do_boundless_das</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">block_output_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;block_output&quot;</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">,</span>
    <span class="n">do_boundless_das</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># all_streams_io_name_df = pd.DataFrame(</span>
<span class="c1">#     block_output_data+</span>
<span class="c1">#     attn_out_data+mlp_out_data+</span>
<span class="c1">#     attn_value_out_data+mlp_act_data+</span>
<span class="c1">#     mlp_input_data+block_input_data+attn_input_data</span>
<span class="c1"># )</span>
<span class="c1"># all_streams_io_name_df.to_csv(&quot;./tutorial_data/all_streams_boundless_das_df.csv&quot;)</span>
<span class="n">all_streams_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;./tutorial_data/all_streams_boundless_das_df.csv&quot;</span><span class="p">)</span>
<span class="n">all_streams_df</span><span class="p">[</span><span class="s2">&quot;IIA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_streams_df</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">all_streams_df</span><span class="p">[</span>
    <span class="n">all_streams_df</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;block_output&quot;</span><span class="p">,</span>
            <span class="s2">&quot;attention_input&quot;</span><span class="p">,</span>
            <span class="s2">&quot;attention_output&quot;</span><span class="p">,</span>
            <span class="s2">&quot;attention_value_output&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
<span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">stream_labels</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;block_output&quot;</span><span class="p">:</span> <span class="s2">&quot;Block Output&quot;</span><span class="p">,</span>
    <span class="s2">&quot;attention_input&quot;</span><span class="p">:</span> <span class="s2">&quot;Attention Input&quot;</span><span class="p">,</span>
    <span class="s2">&quot;attention_output&quot;</span><span class="p">:</span> <span class="s2">&quot;Attention Output</span><span class="se">\n</span><span class="s2">(After Head Mixing)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;attention_value_output&quot;</span><span class="p">:</span> <span class="s2">&quot;Attention Value Output</span><span class="se">\n</span><span class="s2">(Before Head Mixing)&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;stream&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">stream_labels</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">custom_format</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;IIA_formatted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;IIA&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">custom_format</span><span class="p">)</span>
<span class="n">other_locations_plot</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;layer&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;IIA&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;stream&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_line</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">geom_point</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_text</span><span class="p">(</span>
        <span class="n">aes</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;IIA_formatted&quot;</span><span class="p">),</span> <span class="n">nudge_y</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">show_legend</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_minimal</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.72</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">ggtitle</span><span class="p">(</span><span class="s2">&quot;Name Position w/ Boundless DAS&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">ggsave</span><span class="p">(</span>
    <span class="n">other_locations_plot</span><span class="p">,</span>
    <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;./tutorial_data/Boundless_DAS_other_locations_plot.pdf&quot;</span><span class="p">,</span>
    <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">other_locations_plot</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../../_images/7725b3c3b31b963a269bc9cb673c3fd0795f5cb25290fd37d3c8c483e24ba67d.png"><img alt="../../_images/7725b3c3b31b963a269bc9cb673c3fd0795f5cb25290fd37d3c8c483e24ba67d.png" src="../../_images/7725b3c3b31b963a269bc9cb673c3fd0795f5cb25290fd37d3c8c483e24ba67d.png" style="width: 1200px; height: 300px;" /></a>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure Size: (1200 x 300)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_streams_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;./tutorial_data/all_streams_boundless_das_df.csv&quot;</span><span class="p">)</span>
<span class="n">all_streams_df</span><span class="p">[</span><span class="s2">&quot;IIA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_streams_df</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">all_streams_df</span><span class="p">[</span>
    <span class="n">all_streams_df</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">({</span><span class="s2">&quot;mlp_output&quot;</span><span class="p">,</span> <span class="s2">&quot;mlp_input&quot;</span><span class="p">,</span> <span class="s2">&quot;mlp_activation&quot;</span><span class="p">})</span>
<span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">stream_labels</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;mlp_output&quot;</span><span class="p">:</span> <span class="s2">&quot;MLP Output&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mlp_input&quot;</span><span class="p">:</span> <span class="s2">&quot;MLP Input&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mlp_activation&quot;</span><span class="p">:</span> <span class="s2">&quot;MLP Activations&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">stream_labels</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">custom_format</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="n">df</span><span class="p">[</span><span class="s2">&quot;IIA_formatted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;IIA&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">custom_format</span><span class="p">)</span>
<span class="n">all_mlp_locations_plot</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;layer&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;IIA&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;stream&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_line</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">geom_point</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_text</span><span class="p">(</span>
        <span class="n">aes</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;IIA_formatted&quot;</span><span class="p">),</span> <span class="n">nudge_y</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">show_legend</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_minimal</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.72</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">ggtitle</span><span class="p">(</span><span class="s2">&quot;Name Position w/ Boundless DAS&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">ggsave</span><span class="p">(</span>
    <span class="n">all_mlp_locations_plot</span><span class="p">,</span>
    <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;./tutorial_data/Boundless_DAS_all_mlp_locations_plot.pdf&quot;</span><span class="p">,</span>
    <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">all_mlp_locations_plot</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../../_images/bb77bdccb046f5e77b9ea0a5312189dfe2984f404288060a908abd8077786292.png"><img alt="../../_images/bb77bdccb046f5e77b9ea0a5312189dfe2984f404288060a908abd8077786292.png" src="../../_images/bb77bdccb046f5e77b9ea0a5312189dfe2984f404288060a908abd8077786292.png" style="width: 1200px; height: 300px;" /></a>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure Size: (1200 x 300)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">attn_input_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;attention_input&quot;</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>  <span class="c1"># now we are localizing the IO name</span>
    <span class="n">do_boundless_das</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">block_input_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;block_input&quot;</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
    <span class="n">do_boundless_das</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">mlp_input_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;mlp_input&quot;</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
    <span class="n">do_boundless_das</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">mlp_act_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;mlp_activation&quot;</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
    <span class="n">do_boundless_das</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">attn_out_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;attention_output&quot;</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
    <span class="n">do_boundless_das</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">mlp_out_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;mlp_output&quot;</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
    <span class="n">do_boundless_das</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">attn_value_out_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;attention_value_output&quot;</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
    <span class="n">do_boundless_das</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">block_output_data</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span>
    <span class="s2">&quot;block_output&quot;</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
    <span class="n">do_boundless_das</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># all_streams_io_name_df = pd.DataFrame(</span>
<span class="c1">#     block_output_data+</span>
<span class="c1">#     attn_out_data+mlp_out_data+</span>
<span class="c1">#     attn_value_out_data+mlp_act_data+</span>
<span class="c1">#     mlp_input_data+block_input_data+attn_input_data</span>
<span class="c1"># )</span>
<span class="c1"># all_streams_io_name_df.to_csv(&quot;./tutorial_data/all_streams_io_name_boundless_das_df.csv&quot;)</span>
<span class="n">all_streams_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;./tutorial_data/all_streams_io_name_boundless_das_df.csv&quot;</span><span class="p">)</span>
<span class="n">all_streams_df</span><span class="p">[</span><span class="s2">&quot;IIA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_streams_df</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">all_streams_df</span><span class="p">[</span>
    <span class="n">all_streams_df</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;block_output&quot;</span><span class="p">,</span>
            <span class="s2">&quot;attention_input&quot;</span><span class="p">,</span>
            <span class="s2">&quot;attention_output&quot;</span><span class="p">,</span>
            <span class="s2">&quot;attention_value_output&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
<span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">stream_labels</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;block_output&quot;</span><span class="p">:</span> <span class="s2">&quot;Block Output&quot;</span><span class="p">,</span>
    <span class="s2">&quot;attention_input&quot;</span><span class="p">:</span> <span class="s2">&quot;Attention Input&quot;</span><span class="p">,</span>
    <span class="s2">&quot;attention_output&quot;</span><span class="p">:</span> <span class="s2">&quot;Attention Output</span><span class="se">\n</span><span class="s2">(After Head Mixing)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;attention_value_output&quot;</span><span class="p">:</span> <span class="s2">&quot;Attention Value Output</span><span class="se">\n</span><span class="s2">(Before Head Mixing)&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;stream&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">stream_labels</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">custom_format</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;IIA_formatted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;IIA&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">custom_format</span><span class="p">)</span>
<span class="n">other_locations_plot</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;layer&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;IIA&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;stream&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_line</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">geom_point</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_text</span><span class="p">(</span>
        <span class="n">aes</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;IIA_formatted&quot;</span><span class="p">),</span> <span class="n">nudge_y</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">show_legend</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_minimal</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">ggtitle</span><span class="p">(</span><span class="s2">&quot;Correct IO Name (20) w/ Boundless DAS&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">ggsave</span><span class="p">(</span>
    <span class="n">other_locations_plot</span><span class="p">,</span>
    <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;./tutorial_data/Boundless_DAS_IO_name_other_locations_plot.pdf&quot;</span><span class="p">,</span>
    <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">other_locations_plot</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../../_images/fc9a15b5e5ca3ec9f1fd7e08bfd643759f324f90fdc940dfa5a9304a600227da.png"><img alt="../../_images/fc9a15b5e5ca3ec9f1fd7e08bfd643759f324f90fdc940dfa5a9304a600227da.png" src="../../_images/fc9a15b5e5ca3ec9f1fd7e08bfd643759f324f90fdc940dfa5a9304a600227da.png" style="width: 1200px; height: 300px;" /></a>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure Size: (1200 x 300)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_streams_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;./tutorial_data/all_streams_io_name_boundless_das_df.csv&quot;</span><span class="p">)</span>
<span class="n">all_streams_df</span><span class="p">[</span><span class="s2">&quot;IIA&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_streams_df</span><span class="p">[</span><span class="s2">&quot;acc&quot;</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">all_streams_df</span><span class="p">[</span>
    <span class="n">all_streams_df</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">({</span><span class="s2">&quot;mlp_output&quot;</span><span class="p">,</span> <span class="s2">&quot;mlp_input&quot;</span><span class="p">,</span> <span class="s2">&quot;mlp_activation&quot;</span><span class="p">})</span>
<span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">stream_labels</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;mlp_output&quot;</span><span class="p">:</span> <span class="s2">&quot;MLP Output&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mlp_input&quot;</span><span class="p">:</span> <span class="s2">&quot;MLP Input&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mlp_activation&quot;</span><span class="p">:</span> <span class="s2">&quot;MLP Activations&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">stream_labels</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">custom_format</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="n">df</span><span class="p">[</span><span class="s2">&quot;IIA_formatted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;IIA&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">custom_format</span><span class="p">)</span>
<span class="n">all_mlp_locations_plot</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;layer&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;IIA&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;stream&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_line</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">geom_point</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">geom_text</span><span class="p">(</span>
        <span class="n">aes</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;IIA_formatted&quot;</span><span class="p">),</span> <span class="n">nudge_y</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">show_legend</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">theme_minimal</span><span class="p">()</span>
    <span class="o">+</span> <span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.72</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">ggtitle</span><span class="p">(</span><span class="s2">&quot;Correct IO Name (20) w/ Boundless DAS&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">ggsave</span><span class="p">(</span>
    <span class="n">all_mlp_locations_plot</span><span class="p">,</span>
    <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;./tutorial_data/Boundless_DAS_IO_name_all_mlp_locations_plot.pdf&quot;</span><span class="p">,</span>
    <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">all_mlp_locations_plot</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../../_images/53f9d0302373b51b72a09eb116ccd675a00d8316d611a91cb91f0912c3cb9343.png"><img alt="../../_images/53f9d0302373b51b72a09eb116ccd675a00d8316d611a91cb91f0912c3cb9343.png" src="../../_images/53f9d0302373b51b72a09eb116ccd675a00d8316d611a91cb91f0912c3cb9343.png" style="width: 1200px; height: 300px;" /></a>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Figure Size: (1200 x 300)&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="das-and-boundless-das-weight-matrix-and-head-importance">
<h2>DAS and Boundless DAS weight matrix and head importance<a class="headerlink" href="#das-and-boundless-das-weight-matrix-and-head-importance" title="Link to this heading">#</a></h2>
<p>DAS-based methods learn a subspace that is a linear combination of axes in the original basis. Will the learned linear combination (i.e., the learned weights) interpretable by showing head’s importance when applied on top of the attention value output stream before the head mixing? In this section, we investigate this question for both DAS as well as Boundless DAS when aligning with the name position variable as well as the IO name variable.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">boundless_das_intervenable</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">8</span><span class="p">],</span>
    <span class="s2">&quot;attention_value_output&quot;</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">,</span>
    <span class="n">do_boundless_das</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">return_intervenable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>finding name position at: pos-&gt;17, layers-&gt;8, stream-&gt;attention_value_output
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">intervention</span> <span class="o">=</span> <span class="n">boundless_das_intervenable</span><span class="o">.</span><span class="n">interventions</span><span class="p">[</span>
    <span class="s2">&quot;layer_8_repr_attention_value_output_unit_pos_nunit_1#0&quot;</span>
<span class="p">]</span>
<span class="n">boundary_mask</span> <span class="o">=</span> <span class="n">sigmoid_boundary</span><span class="p">(</span>
    <span class="n">intervention</span><span class="o">.</span><span class="n">intervention_population</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">intervention</span><span class="o">.</span><span class="n">intervention_boundaries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">intervention</span><span class="o">.</span><span class="n">embed_dim</span><span class="p">),</span>
    <span class="n">intervention</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">learned_weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">intervention</span><span class="o">.</span><span class="n">rotate_layer</span><span class="o">.</span><span class="n">weight</span> <span class="o">*</span> <span class="n">boundary_mask</span><span class="p">)[</span>
    <span class="p">:,</span> <span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">intervention</span><span class="o">.</span><span class="n">intervention_boundaries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">768</span><span class="p">)</span>
<span class="p">]</span>
<span class="n">headwise_learned_weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">learned_weights</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">sampled_weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">headwise_learned_weights</span><span class="p">]</span>

<span class="c1"># Assuming your_list is your 2D list where each sublist is a NumPy array</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Head </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sampled_weights</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">sublist</span>
    <span class="p">],</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Group&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;Group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Group&quot;</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Head </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="c1"># Plotting</span>
<span class="n">boundless_das_weight_plot</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;Value&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;Group&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_histogram</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">facet_wrap</span><span class="p">(</span><span class="s2">&quot;~Group&quot;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span>  <span class="c1"># Arrange in a grid with 3 columns</span>
        <span class="n">legend_position</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">subplots_adjust</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;wspace&quot;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span> <span class="s2">&quot;hspace&quot;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;Value&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Count&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">ggsave</span><span class="p">(</span>
    <span class="n">boundless_das_weight_plot</span><span class="p">,</span>
    <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;./tutorial_data/Boundless_DAS_weight_plot.pdf&quot;</span><span class="p">,</span>
    <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">boundless_das_weight_plot</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/7cf499431f3c7362117ca1ffa99f0fa159dc9c59b16d5108f71d62f8108156c6.svg" src="../../_images/7cf499431f3c7362117ca1ffa99f0fa159dc9c59b16d5108f71d62f8108156c6.svg" /><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">das_intervenable</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">8</span><span class="p">],</span>
    <span class="s2">&quot;attention_value_output&quot;</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;position&quot;</span><span class="p">,</span>
    <span class="n">return_intervenable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>finding name position at: pos-&gt;17, layers-&gt;8, stream-&gt;attention_value_output
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">intervention</span> <span class="o">=</span> <span class="n">das_intervenable</span><span class="o">.</span><span class="n">interventions</span><span class="p">[</span>
    <span class="s2">&quot;layer_8_repr_attention_value_output_unit_pos_nunit_1#0&quot;</span>
<span class="p">]</span>
<span class="n">learned_weights</span> <span class="o">=</span> <span class="n">intervention</span><span class="o">.</span><span class="n">rotate_layer</span><span class="o">.</span><span class="n">weight</span>
<span class="n">headwise_learned_weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">learned_weights</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">sampled_weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">headwise_learned_weights</span><span class="p">]</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Head </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sampled_weights</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">sublist</span>
    <span class="p">],</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Group&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;Group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Group&quot;</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Head </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="c1"># Plotting</span>
<span class="n">das_weight_plot</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;Value&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;Group&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_histogram</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">facet_wrap</span><span class="p">(</span><span class="s2">&quot;~Group&quot;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span>  <span class="c1"># Arrange in a grid with 3 columns</span>
        <span class="n">legend_position</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">subplots_adjust</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;wspace&quot;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span> <span class="s2">&quot;hspace&quot;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;Value&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Count&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">ggsave</span><span class="p">(</span><span class="n">das_weight_plot</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;./tutorial_data/DAS_weight_plot.pdf&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">das_weight_plot</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/aebce4a12767db3fd69964bc17f4268415d639eda8d92d842d7ded3ba1828056.svg" src="../../_images/aebce4a12767db3fd69964bc17f4268415d639eda8d92d842d7ded3ba1828056.svg" /><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">boundless_das_intervenable</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">9</span><span class="p">],</span>
    <span class="s2">&quot;attention_value_output&quot;</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
    <span class="n">do_boundless_das</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">return_intervenable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>finding name position at: pos-&gt;17, layers-&gt;9, stream-&gt;attention_value_output
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">intervention</span> <span class="o">=</span> <span class="n">boundless_das_intervenable</span><span class="o">.</span><span class="n">interventions</span><span class="p">[</span>
    <span class="s2">&quot;layer_9_repr_attention_value_output_unit_pos_nunit_1#0&quot;</span>
<span class="p">]</span>
<span class="n">boundary_mask</span> <span class="o">=</span> <span class="n">sigmoid_boundary</span><span class="p">(</span>
    <span class="n">intervention</span><span class="o">.</span><span class="n">intervention_population</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">intervention</span><span class="o">.</span><span class="n">intervention_boundaries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="n">intervention</span><span class="o">.</span><span class="n">embed_dim</span><span class="p">),</span>
    <span class="n">intervention</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">learned_weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">intervention</span><span class="o">.</span><span class="n">rotate_layer</span><span class="o">.</span><span class="n">weight</span> <span class="o">*</span> <span class="n">boundary_mask</span><span class="p">)[</span>
    <span class="p">:,</span> <span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">intervention</span><span class="o">.</span><span class="n">intervention_boundaries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">768</span><span class="p">)</span>
<span class="p">]</span>
<span class="n">headwise_learned_weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">learned_weights</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">sampled_weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">headwise_learned_weights</span><span class="p">]</span>

<span class="c1"># Assuming your_list is your 2D list where each sublist is a NumPy array</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Head </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sampled_weights</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">sublist</span>
    <span class="p">],</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Group&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;Group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Group&quot;</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Head </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="c1"># Plotting</span>
<span class="n">boundless_das_weight_plot</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;Value&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;Group&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_histogram</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">facet_wrap</span><span class="p">(</span><span class="s2">&quot;~Group&quot;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span>  <span class="c1"># Arrange in a grid with 3 columns</span>
        <span class="n">legend_position</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">subplots_adjust</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;wspace&quot;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span> <span class="s2">&quot;hspace&quot;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;Value&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Count&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">ggsave</span><span class="p">(</span>
    <span class="n">boundless_das_weight_plot</span><span class="p">,</span>
    <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;./tutorial_data/Boundless_DAS_IO_name_weight_plot.pdf&quot;</span><span class="p">,</span>
    <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">boundless_das_weight_plot</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/6ac0fedb49fc4a4d44a6941c256db0b3a7d64421a4712f3137c5991b235b3895.svg" src="../../_images/6ac0fedb49fc4a4d44a6941c256db0b3a7d64421a4712f3137c5991b235b3895.svg" /><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">das_intervenable</span> <span class="o">=</span> <span class="n">find_variable_at</span><span class="p">(</span>
    <span class="n">gpt2</span><span class="p">,</span>
    <span class="n">tokenizer</span><span class="p">,</span>
    <span class="p">[</span><span class="mi">17</span><span class="p">],</span>
    <span class="p">[</span><span class="mi">9</span><span class="p">],</span>
    <span class="s2">&quot;attention_value_output&quot;</span><span class="p">,</span>
    <span class="n">low_rank_dimension</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="n">aligning_variable</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span>
    <span class="n">return_intervenable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>finding name position at: pos-&gt;17, layers-&gt;9, stream-&gt;attention_value_output
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">intervention</span> <span class="o">=</span> <span class="n">das_intervenable</span><span class="o">.</span><span class="n">interventions</span><span class="p">[</span>
    <span class="s2">&quot;layer_9_repr_attention_value_output_unit_pos_nunit_1#0&quot;</span>
<span class="p">]</span>
<span class="n">learned_weights</span> <span class="o">=</span> <span class="n">intervention</span><span class="o">.</span><span class="n">rotate_layer</span><span class="o">.</span><span class="n">weight</span>
<span class="n">headwise_learned_weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">chunk</span><span class="p">(</span><span class="n">learned_weights</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">sampled_weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">headwise_learned_weights</span><span class="p">]</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Head </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sampled_weights</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">sublist</span>
    <span class="p">],</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Group&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;Group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Group&quot;</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Head </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">)],</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="c1"># Plotting</span>
<span class="n">das_weight_plot</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;Value&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;Group&quot;</span><span class="p">))</span>
    <span class="o">+</span> <span class="n">geom_histogram</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">facet_wrap</span><span class="p">(</span><span class="s2">&quot;~Group&quot;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="o">+</span> <span class="n">theme</span><span class="p">(</span>  <span class="c1"># Arrange in a grid with 3 columns</span>
        <span class="n">legend_position</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">subplots_adjust</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;wspace&quot;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span> <span class="s2">&quot;hspace&quot;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="o">+</span> <span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;Value&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;Count&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">ggsave</span><span class="p">(</span><span class="n">das_weight_plot</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;./tutorial_data/DAS_IO_name_weight_plot.pdf&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">das_weight_plot</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/3a9c1a0fea1e610ed044635a984b68db3aff6f1f3df1a6771625efc2cc01d108.svg" src="../../_images/3a9c1a0fea1e610ed044635a984b68db3aff6f1f3df1a6771625efc2cc01d108.svg" /><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
<p><strong>Findings:</strong> DAS learned weights map very well to head importance! In the plot above, we can see that Heads 6 and 10 have many non-zero entries, indicating that these neurons contribute significantly to aligning with the name position information. Boundless DAS shows a less salient result, suggesting that it learns a more distributed representation.</p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="IOI_Replication.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Replicating the IOI paper</p>
      </div>
    </a>
    <a class="right-next"
       href="IOI_with_Mask_Intervention.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">IOI with Masked Interventions</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#overview">Overview</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-up">Set-up</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#factual-recall">Factual recall</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#localizing-the-name-position-information-in-the-main-residual-stream-and-mlp-activations">Localizing the name position information in the main residual stream and MLP activations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#localizing-in-across-multiple-tokens-at-layer-7-one-layer-earlier-than-layer-8">Localizing in across multiple tokens at layer 7, one layer earlier than layer 8</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#localizing-in-different-streams">Localizing in different streams</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#localizing-in-each-individual-head-at-layer-7-and-8">Localizing in each individual head at layer 7 and 8</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#localizing-with-group-of-heads-using-rankings-of-missing-out-head-iia">Localizing with group of heads using rankings of missing out head IIA</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#localizing-the-correct-io-name-with-vanilla-causal-abstraction-no-training">Localizing the correct IO name with vanilla causal abstraction (no training)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#localizing-the-correct-io-name-with-das-20-names-only-with-20-dimension-das">Localizing the correct IO name with DAS (20 names only with 20 dimension DAS)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#head-s-query-representations-to-trace-name-mover-head">Head’s Query Representations to Trace Name Mover Head</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-boundless-das-to-find-information">Use Boundless DAS to find information</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#das-and-boundless-das-weight-matrix-and-head-importance">DAS and Boundless DAS weight matrix and head importance</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Stanford NLP
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024, Stanford NLP.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>